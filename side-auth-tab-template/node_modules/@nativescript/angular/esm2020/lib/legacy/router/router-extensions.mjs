import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { NativeScriptDebug } from '../../trace';
import { FrameService } from '../frame.service';
import { NSLocationStrategy } from './ns-location-strategy';
import { findTopActivatedRouteNodeForOutlet } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "./ns-location-strategy";
import * as i3 from "../frame.service";
export class RouterExtensions {
    constructor(router, locationStrategy, frameService) {
        this.router = router;
        this.locationStrategy = locationStrategy;
        this.frameService = frameService;
    }
    navigate(commands, extras) {
        return this.router.navigate(commands, extras);
    }
    navigateByUrl(url, options) {
        return this.router.navigateByUrl(url, options);
    }
    back(backNavigationOptions) {
        if (backNavigationOptions) {
            this.backOutlets(backNavigationOptions);
        }
        else {
            this.locationStrategy.back();
        }
    }
    canGoBack(backNavigationOptions) {
        let canGoBack = true;
        if (backNavigationOptions) {
            const { outletsToBack, outlets } = this.findOutletsToBack(backNavigationOptions);
            if (outletsToBack.length !== outlets.length) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            else {
                outletsToBack.forEach((outletToBack) => {
                    if (!this.locationStrategy.canGoBack(outletToBack)) {
                        canGoBack = false;
                    }
                });
            }
        }
        else {
            canGoBack = this.locationStrategy.canGoBack();
        }
        return canGoBack;
    }
    backToPreviousPage() {
        this.frameService.getFrame().goBack();
    }
    canGoBackToPreviousPage() {
        return this.frameService.getFrame().canGoBack();
    }
    backOutlets(options) {
        const { outletsToBack, outlets } = this.findOutletsToBack(options);
        if (outletsToBack.length !== outlets.length) {
            NativeScriptDebug.routerError('No outlet found relative to activated route');
        }
        else {
            outletsToBack.forEach((outletToBack) => {
                if (outletToBack.isPageNavigationBack) {
                    NativeScriptDebug.routerError('Attempted to call startGoBack while going back:');
                }
                else {
                    this.locationStrategy.back(outletToBack);
                }
            });
        }
    }
    // tslint:disable-next-line:max-line-length
    findOutletsToBack(options) {
        const rootRoute = this.router.routerState.root;
        let outlets = options.outlets;
        let relativeRoute = options.relativeTo || rootRoute;
        const relativeRouteOutlet = this.findOutletByRoute(relativeRoute);
        const isNSEmptyOutlet = relativeRouteOutlet && relativeRouteOutlet.isNSEmptyOutlet;
        // Lazy named outlet has added 'primary' inner NSEmptyOutlet child.
        // Take parent route when `relativeTo` option points to the outer named outlet.
        if (isNSEmptyOutlet && relativeRoute.outlet !== 'primary') {
            relativeRoute = relativeRoute.parent || relativeRoute;
        }
        outlets = outlets || [relativeRoute.outlet];
        const outletsToBack = this.findOutletsRecursive([...outlets], relativeRoute);
        return { outletsToBack: outletsToBack, outlets: outlets };
    }
    // warning, outlets is mutable!
    findOutletsRecursive(outlets, route) {
        if (!route || outlets.length === 0) {
            return [];
        }
        const outletsToBack = [];
        if (outlets.some((currentOutlet) => currentOutlet === route.outlet)) {
            const outlet = this.findOutletByRoute(route);
            if (outlet) {
                outlets.splice(outlets.indexOf(route.outlet), 1);
                outletsToBack.push(outlet);
            }
        }
        if (!route.children) {
            return outletsToBack;
        }
        for (let index = 0; index < route.children.length; index++) {
            if (outlets.length === 0) {
                break;
            }
            const currentRoute = route.children[index];
            outletsToBack.push(...this.findOutletsRecursive(outlets, currentRoute));
        }
        return outletsToBack;
    }
    findOutletByRoute(currentRoute) {
        const currentRouteSnapshop = findTopActivatedRouteNodeForOutlet(currentRoute.snapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(currentRouteSnapshop);
        const outlet = this.locationStrategy.findOutlet(outletKey, currentRouteSnapshop);
        return outlet;
    }
}
RouterExtensions.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: RouterExtensions, deps: [{ token: i1.Router }, { token: i2.NSLocationStrategy }, { token: i3.FrameService }], target: i0.ɵɵFactoryTarget.Injectable });
RouterExtensions.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: RouterExtensions, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: RouterExtensions, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.Router }, { type: i2.NSLocationStrategy }, { type: i3.FrameService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLWV4dGVuc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9yb3V0ZXItZXh0ZW5zaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBK0QsTUFBTSxFQUFXLE1BQU0saUJBQWlCLENBQUM7QUFDL0csT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7Ozs7QUFhaEYsTUFBTSxPQUFPLGdCQUFnQjtJQUMzQixZQUFtQixNQUFjLEVBQVMsZ0JBQW9DLEVBQVMsWUFBMEI7UUFBOUYsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUFBUyxpQkFBWSxHQUFaLFlBQVksQ0FBYztJQUFHLENBQUM7SUFFOUcsUUFBUSxDQUFDLFFBQWUsRUFBRSxNQUFpQztRQUNoRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRU0sYUFBYSxDQUFDLEdBQXFCLEVBQUUsT0FBMkM7UUFDckYsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVNLElBQUksQ0FBQyxxQkFBNkM7UUFDdkQsSUFBSSxxQkFBcUIsRUFBRTtZQUN6QixJQUFJLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUM7U0FDekM7YUFBTTtZQUNMLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUM5QjtJQUNILENBQUM7SUFFTSxTQUFTLENBQUMscUJBQTZDO1FBQzVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLHFCQUFxQixFQUFFO1lBQ3pCLE1BQU0sRUFBRSxhQUFhLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLENBQUM7WUFFakYsSUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLE9BQU8sQ0FBQyxNQUFNLEVBQUU7Z0JBQzNDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO2FBQzlFO2lCQUFNO2dCQUNMLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRTtvQkFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUU7d0JBQ2xELFNBQVMsR0FBRyxLQUFLLENBQUM7cUJBQ25CO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjthQUFNO1lBQ0wsU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUMvQztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSxrQkFBa0I7UUFDdkIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRU0sdUJBQXVCO1FBQzVCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNsRCxDQUFDO0lBRU8sV0FBVyxDQUFDLE9BQThCO1FBQ2hELE1BQU0sRUFBRSxhQUFhLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5FLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQzNDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1NBQzlFO2FBQU07WUFDTCxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQ3JDLElBQUksWUFBWSxDQUFDLG9CQUFvQixFQUFFO29CQUNyQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsaURBQWlELENBQUMsQ0FBQztpQkFDbEY7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDMUM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVELDJDQUEyQztJQUNuQyxpQkFBaUIsQ0FBQyxPQUErQjtRQUN2RCxNQUFNLFNBQVMsR0FBbUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQy9ELElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDOUIsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLFVBQVUsSUFBSSxTQUFTLENBQUM7UUFFcEQsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEUsTUFBTSxlQUFlLEdBQUcsbUJBQW1CLElBQUksbUJBQW1CLENBQUMsZUFBZSxDQUFDO1FBRW5GLG1FQUFtRTtRQUNuRSwrRUFBK0U7UUFDL0UsSUFBSSxlQUFlLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDekQsYUFBYSxHQUFHLGFBQWEsQ0FBQyxNQUFNLElBQUksYUFBYSxDQUFDO1NBQ3ZEO1FBRUQsT0FBTyxHQUFHLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU1QyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRTdFLE9BQU8sRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUM1RCxDQUFDO0lBRUQsK0JBQStCO0lBQ3ZCLG9CQUFvQixDQUFDLE9BQWlCLEVBQUUsS0FBc0I7UUFDcEUsSUFBSSxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNsQyxPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsYUFBYSxLQUFLLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNuRSxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDN0MsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDakQsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUM1QjtTQUNGO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDbkIsT0FBTyxhQUFhLENBQUM7U0FDdEI7UUFDRCxLQUFLLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRSxLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDMUQsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDeEIsTUFBTTthQUNQO1lBQ0QsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQ3pFO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFlBQTRCO1FBQ3BELE1BQU0sb0JBQW9CLEdBQUcsa0NBQWtDLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQy9FLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFFakYsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7NkdBdEhVLGdCQUFnQjtpSEFBaEIsZ0JBQWdCLGNBRmYsTUFBTTsyRkFFUCxnQkFBZ0I7a0JBSDVCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIE5hdmlnYXRpb25CZWhhdmlvck9wdGlvbnMsIE5hdmlnYXRpb25FeHRyYXMsIFJvdXRlciwgVXJsVHJlZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4uLy4uL3RyYWNlJztcbmltcG9ydCB7IEZyYW1lU2VydmljZSB9IGZyb20gJy4uL2ZyYW1lLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uT3B0aW9ucywgT3V0bGV0IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi11dGlscyc7XG5pbXBvcnQgeyBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0IH0gZnJvbSAnLi9wYWdlLXJvdXRlci1vdXRsZXQtdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBFeHRlbmRlZE5hdmlnYXRpb25FeHRyYXMgPSBOYXZpZ2F0aW9uRXh0cmFzICYgTmF2aWdhdGlvbk9wdGlvbnM7XG5leHBvcnQgdHlwZSBFeHRlbmRlZE5hdmlnYXRpb25CZWhhdmlvck9wdGlvbnMgPSBOYXZpZ2F0aW9uQmVoYXZpb3JPcHRpb25zICYgTmF2aWdhdGlvbk9wdGlvbnM7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFja05hdmlnYXRpb25PcHRpb25zIHtcbiAgb3V0bGV0cz86IEFycmF5PHN0cmluZz47XG4gIHJlbGF0aXZlVG8/OiBBY3RpdmF0ZWRSb3V0ZSB8IG51bGw7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBSb3V0ZXJFeHRlbnNpb25zIHtcbiAgY29uc3RydWN0b3IocHVibGljIHJvdXRlcjogUm91dGVyLCBwdWJsaWMgbG9jYXRpb25TdHJhdGVneTogTlNMb2NhdGlvblN0cmF0ZWd5LCBwdWJsaWMgZnJhbWVTZXJ2aWNlOiBGcmFtZVNlcnZpY2UpIHt9XG5cbiAgcHVibGljIG5hdmlnYXRlKGNvbW1hbmRzOiBhbnlbXSwgZXh0cmFzPzogRXh0ZW5kZWROYXZpZ2F0aW9uRXh0cmFzKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlKGNvbW1hbmRzLCBleHRyYXMpO1xuICB9XG5cbiAgcHVibGljIG5hdmlnYXRlQnlVcmwodXJsOiBzdHJpbmcgfCBVcmxUcmVlLCBvcHRpb25zPzogRXh0ZW5kZWROYXZpZ2F0aW9uQmVoYXZpb3JPcHRpb25zKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXJsLCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBiYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucz86IEJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgIGlmIChiYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcbiAgICAgIHRoaXMuYmFja091dGxldHMoYmFja05hdmlnYXRpb25PcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2soKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2FuR29CYWNrKGJhY2tOYXZpZ2F0aW9uT3B0aW9ucz86IEJhY2tOYXZpZ2F0aW9uT3B0aW9ucykge1xuICAgIGxldCBjYW5Hb0JhY2sgPSB0cnVlO1xuICAgIGlmIChiYWNrTmF2aWdhdGlvbk9wdGlvbnMpIHtcbiAgICAgIGNvbnN0IHsgb3V0bGV0c1RvQmFjaywgb3V0bGV0cyB9ID0gdGhpcy5maW5kT3V0bGV0c1RvQmFjayhiYWNrTmF2aWdhdGlvbk9wdGlvbnMpO1xuXG4gICAgICBpZiAob3V0bGV0c1RvQmFjay5sZW5ndGggIT09IG91dGxldHMubGVuZ3RoKSB7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdObyBvdXRsZXQgZm91bmQgcmVsYXRpdmUgdG8gYWN0aXZhdGVkIHJvdXRlJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRsZXRzVG9CYWNrLmZvckVhY2goKG91dGxldFRvQmFjaykgPT4ge1xuICAgICAgICAgIGlmICghdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmNhbkdvQmFjayhvdXRsZXRUb0JhY2spKSB7XG4gICAgICAgICAgICBjYW5Hb0JhY2sgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjYW5Hb0JhY2sgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuY2FuR29CYWNrKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhbkdvQmFjaztcbiAgfVxuXG4gIHB1YmxpYyBiYWNrVG9QcmV2aW91c1BhZ2UoKSB7XG4gICAgdGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKS5nb0JhY2soKTtcbiAgfVxuXG4gIHB1YmxpYyBjYW5Hb0JhY2tUb1ByZXZpb3VzUGFnZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZVNlcnZpY2UuZ2V0RnJhbWUoKS5jYW5Hb0JhY2soKTtcbiAgfVxuXG4gIHByaXZhdGUgYmFja091dGxldHMob3B0aW9uczogQmFja05hdmlnYXRpb25PcHRpb25zKSB7XG4gICAgY29uc3QgeyBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzIH0gPSB0aGlzLmZpbmRPdXRsZXRzVG9CYWNrKG9wdGlvbnMpO1xuXG4gICAgaWYgKG91dGxldHNUb0JhY2subGVuZ3RoICE9PSBvdXRsZXRzLmxlbmd0aCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyRXJyb3IoJ05vIG91dGxldCBmb3VuZCByZWxhdGl2ZSB0byBhY3RpdmF0ZWQgcm91dGUnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgb3V0bGV0c1RvQmFjay5mb3JFYWNoKChvdXRsZXRUb0JhY2spID0+IHtcbiAgICAgICAgaWYgKG91dGxldFRvQmFjay5pc1BhZ2VOYXZpZ2F0aW9uQmFjaykge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBzdGFydEdvQmFjayB3aGlsZSBnb2luZyBiYWNrOicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5iYWNrKG91dGxldFRvQmFjayk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgcHJpdmF0ZSBmaW5kT3V0bGV0c1RvQmFjayhvcHRpb25zPzogQmFja05hdmlnYXRpb25PcHRpb25zKTogeyBvdXRsZXRzVG9CYWNrOiBBcnJheTxPdXRsZXQ+OyBvdXRsZXRzOiBBcnJheTxzdHJpbmc+IH0ge1xuICAgIGNvbnN0IHJvb3RSb3V0ZTogQWN0aXZhdGVkUm91dGUgPSB0aGlzLnJvdXRlci5yb3V0ZXJTdGF0ZS5yb290O1xuICAgIGxldCBvdXRsZXRzID0gb3B0aW9ucy5vdXRsZXRzO1xuICAgIGxldCByZWxhdGl2ZVJvdXRlID0gb3B0aW9ucy5yZWxhdGl2ZVRvIHx8IHJvb3RSb3V0ZTtcblxuICAgIGNvbnN0IHJlbGF0aXZlUm91dGVPdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeVJvdXRlKHJlbGF0aXZlUm91dGUpO1xuICAgIGNvbnN0IGlzTlNFbXB0eU91dGxldCA9IHJlbGF0aXZlUm91dGVPdXRsZXQgJiYgcmVsYXRpdmVSb3V0ZU91dGxldC5pc05TRW1wdHlPdXRsZXQ7XG5cbiAgICAvLyBMYXp5IG5hbWVkIG91dGxldCBoYXMgYWRkZWQgJ3ByaW1hcnknIGlubmVyIE5TRW1wdHlPdXRsZXQgY2hpbGQuXG4gICAgLy8gVGFrZSBwYXJlbnQgcm91dGUgd2hlbiBgcmVsYXRpdmVUb2Agb3B0aW9uIHBvaW50cyB0byB0aGUgb3V0ZXIgbmFtZWQgb3V0bGV0LlxuICAgIGlmIChpc05TRW1wdHlPdXRsZXQgJiYgcmVsYXRpdmVSb3V0ZS5vdXRsZXQgIT09ICdwcmltYXJ5Jykge1xuICAgICAgcmVsYXRpdmVSb3V0ZSA9IHJlbGF0aXZlUm91dGUucGFyZW50IHx8IHJlbGF0aXZlUm91dGU7XG4gICAgfVxuXG4gICAgb3V0bGV0cyA9IG91dGxldHMgfHwgW3JlbGF0aXZlUm91dGUub3V0bGV0XTtcblxuICAgIGNvbnN0IG91dGxldHNUb0JhY2sgPSB0aGlzLmZpbmRPdXRsZXRzUmVjdXJzaXZlKFsuLi5vdXRsZXRzXSwgcmVsYXRpdmVSb3V0ZSk7XG5cbiAgICByZXR1cm4geyBvdXRsZXRzVG9CYWNrOiBvdXRsZXRzVG9CYWNrLCBvdXRsZXRzOiBvdXRsZXRzIH07XG4gIH1cblxuICAvLyB3YXJuaW5nLCBvdXRsZXRzIGlzIG11dGFibGUhXG4gIHByaXZhdGUgZmluZE91dGxldHNSZWN1cnNpdmUob3V0bGV0czogc3RyaW5nW10sIHJvdXRlPzogQWN0aXZhdGVkUm91dGUpIHtcbiAgICBpZiAoIXJvdXRlIHx8IG91dGxldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IG91dGxldHNUb0JhY2sgPSBbXTtcbiAgICBpZiAob3V0bGV0cy5zb21lKChjdXJyZW50T3V0bGV0KSA9PiBjdXJyZW50T3V0bGV0ID09PSByb3V0ZS5vdXRsZXQpKSB7XG4gICAgICBjb25zdCBvdXRsZXQgPSB0aGlzLmZpbmRPdXRsZXRCeVJvdXRlKHJvdXRlKTtcbiAgICAgIGlmIChvdXRsZXQpIHtcbiAgICAgICAgb3V0bGV0cy5zcGxpY2Uob3V0bGV0cy5pbmRleE9mKHJvdXRlLm91dGxldCksIDEpO1xuICAgICAgICBvdXRsZXRzVG9CYWNrLnB1c2gob3V0bGV0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKCFyb3V0ZS5jaGlsZHJlbikge1xuICAgICAgcmV0dXJuIG91dGxldHNUb0JhY2s7XG4gICAgfVxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByb3V0ZS5jaGlsZHJlbi5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGlmIChvdXRsZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IGN1cnJlbnRSb3V0ZSA9IHJvdXRlLmNoaWxkcmVuW2luZGV4XTtcbiAgICAgIG91dGxldHNUb0JhY2sucHVzaCguLi50aGlzLmZpbmRPdXRsZXRzUmVjdXJzaXZlKG91dGxldHMsIGN1cnJlbnRSb3V0ZSkpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0bGV0c1RvQmFjaztcbiAgfVxuXG4gIHByaXZhdGUgZmluZE91dGxldEJ5Um91dGUoY3VycmVudFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSk6IE91dGxldCB7XG4gICAgY29uc3QgY3VycmVudFJvdXRlU25hcHNob3AgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KGN1cnJlbnRSb3V0ZS5zbmFwc2hvdCk7XG4gICAgY29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmdldFJvdXRlRnVsbFBhdGgoY3VycmVudFJvdXRlU25hcHNob3ApO1xuICAgIGNvbnN0IG91dGxldCA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5maW5kT3V0bGV0KG91dGxldEtleSwgY3VycmVudFJvdXRlU25hcHNob3ApO1xuXG4gICAgcmV0dXJuIG91dGxldDtcbiAgfVxufVxuIl19