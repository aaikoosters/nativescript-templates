import { Injectable } from '@angular/core';
import { NativeScriptDebug } from '../../trace';
import { NSLocationStrategy } from './ns-location-strategy';
import { destroyComponentRef, findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol } from './page-router-outlet-utils';
import * as i0 from "@angular/core";
import * as i1 from "./ns-location-strategy";
const getSnapshotKey = function (snapshot) {
    return snapshot.pathFromRoot.join('->');
};
/**
 * Detached state cache
 */
class DetachedStateCache {
    constructor() {
        this.cache = new Array();
    }
    get length() {
        return this.cache.length;
    }
    push(cacheItem) {
        this.cache.push(cacheItem);
    }
    pop() {
        return this.cache.pop();
    }
    peek() {
        return this.cache[this.cache.length - 1];
    }
    clear() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clear() ${this.cache.length} items will be destroyed`);
        }
        while (this.cache.length > 0) {
            const state = this.cache.pop().state;
            if (!state.componentRef) {
                throw new Error('No componentRef found in DetachedRouteHandle');
            }
            destroyComponentRef(state.componentRef);
        }
    }
    markCurrentForClear() {
        for (const item of this.cache) {
            item.markedForDeletion = true;
        }
    }
    clearMarked() {
        // try to preserve same order as .clear()
        for (let i = this.cache.length - 1; i >= 0; i--) {
            const cacheItem = this.cache[i];
            if (cacheItem.markedForDeletion) {
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                this.cache.splice(i, 1);
            }
        }
    }
    clearModalCache() {
        let removedItemsCount = 0;
        const hasModalPages = this.cache.some((cacheItem) => {
            return cacheItem.isModal;
        });
        if (hasModalPages) {
            let modalCacheCleared = false;
            while (!modalCacheCleared) {
                const cacheItem = this.peek();
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                if (cacheItem.isModal) {
                    modalCacheCleared = true;
                }
                this.pop();
                removedItemsCount++;
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clearModalCache() ${removedItemsCount} items will be destroyed`);
        }
    }
}
/**
 * Detaches subtrees loaded inside PageRouterOutlet in forward navigation
 * and reattaches them on back.
 * Reuses routes as long as their route config is the same.
 */
export class NSRouteReuseStrategy {
    constructor(location) {
        this.location = location;
        this.cacheByOutlet = {};
    }
    shouldDetach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet } = this.findValidOutletAndKey(route);
        const key = getSnapshotKey(route);
        let isPageActivated = false;
        let tmp = route;
        while (!(isPageActivated = tmp[pageRouterActivatedSymbol]) && tmp.parent) {
            tmp = tmp.parent;
        }
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        let shouldDetach = outlet && !isBack && isPageActivated;
        if (outlet) {
            if (outlet.parent && !outlet.parent.shouldDetach) {
                shouldDetach = false;
            }
            outlet.shouldDetach = shouldDetach;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldDetach isBack: ${isBack} key: ${key} result: ${shouldDetach}`);
        }
        return shouldDetach;
    }
    findValidOutletAndKey(targetRoute) {
        let route = targetRoute;
        const routeOutletKey = this.location.getRouteFullPath(route);
        let outletKey = routeOutletKey;
        let outlet = this.location.findOutlet(outletKey, route);
        while (!outlet) {
            if (!route.parent) {
                return { outlet: null, outletKey: routeOutletKey };
            }
            route = route.parent;
            outletKey = this.location.getRouteFullPath(route);
            outlet = this.location.findOutlet(outletKey, route);
        }
        if (outlet) {
            while (!outlet.outletKeys.includes(outletKey)) {
                if (!route.parent) {
                    NativeScriptDebug.routeReuseStrategyLog(`Could not find valid outlet key for route: ${targetRoute}.`);
                    return { outlet, outletKey: routeOutletKey };
                }
                route = route.parent;
                outletKey = this.location.getRouteFullPath(route);
            }
        }
        return { outlet, outletKey };
    }
    shouldAttach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return false;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const shouldAttach = isBack && cache.peek()?.key === key;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldAttach isBack: ${isBack} key: ${key} result: ${shouldAttach}`);
        }
        if (outlet) {
            outlet.shouldDetach = true;
        }
        return shouldAttach;
    }
    store(route, state) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const key = getSnapshotKey(route);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`store key: ${key}, state: ${state}`);
        }
        const { outletKey } = this.findValidOutletAndKey(route);
        // tslint:disable-next-line:max-line-length
        const cache = (this.cacheByOutlet[outletKey] = this.cacheByOutlet[outletKey] || new DetachedStateCache());
        if (state) {
            let isModal = false;
            if (this.location._modalNavigationDepth > 0) {
                isModal = true;
            }
            cache.push({ key, state, isModal });
        }
        else {
            const topItem = cache.peek();
            if (topItem.key === key) {
                cache.pop();
                if (!cache.length) {
                    delete this.cacheByOutlet[outletKey];
                }
            }
            else {
                throw new Error("Trying to pop from DetachedStateCache but keys don't match. " + `expected: ${topItem.key} actual: ${key}`);
            }
        }
    }
    retrieve(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const { outlet, outletKey } = this.findValidOutletAndKey(route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return null;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const cachedItem = cache.peek();
        let state = null;
        if (isBack && cachedItem && cachedItem.key === key) {
            state = cachedItem.state;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`retrieved isBack: ${isBack} key: ${key} state: ${state}`);
        }
        return state;
    }
    shouldReuseRoute(future, curr) {
        const shouldReuse = future.routeConfig === curr.routeConfig;
        if (shouldReuse && curr && curr[pageRouterActivatedSymbol]) {
            // When reusing route - copy the pageRouterActivated to the new snapshot
            // It's needed in shouldDetach to determine if the route should be detached.
            future[pageRouterActivatedSymbol] = curr[pageRouterActivatedSymbol];
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldReuseRoute result: ${shouldReuse}`);
        }
        return shouldReuse;
    }
    clearCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clear();
        }
    }
    markCacheForClear(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.markCurrentForClear();
        }
    }
    popCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            if (cache.peek()) {
                const state = cache.pop()?.state;
                if (state?.componentRef) {
                    destroyComponentRef(state?.componentRef);
                }
            }
        }
    }
    markCacheForPop(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            const item = cache.peek();
            if (item) {
                item.markedForDeletion = true;
            }
        }
    }
    clearMarkedCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearMarked();
        }
    }
    clearModalCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearModalCache();
        }
    }
}
NSRouteReuseStrategy.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: NSRouteReuseStrategy, deps: [{ token: i1.NSLocationStrategy }], target: i0.ɵɵFactoryTarget.Injectable });
NSRouteReuseStrategy.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: NSRouteReuseStrategy });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.2", ngImport: i0, type: NSRouteReuseStrategy, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NSLocationStrategy }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9hbmd1bGFyL3NyYy9saWIvbGVnYWN5L3JvdXRlci9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsa0NBQWtDLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7O0FBU2hJLE1BQU0sY0FBYyxHQUFHLFVBQVUsUUFBZ0M7SUFDL0QsT0FBTyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQyxDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sa0JBQWtCO0lBQXhCO1FBQ1UsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7SUFzRnpDLENBQUM7SUFwRkMsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUMzQixDQUFDO0lBRU0sSUFBSSxDQUFDLFNBQW9CO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxHQUFHO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxLQUFLO1FBQ1Ys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QUNyQjtJQUNILENBQUM7SUFFRCxlQUFlLENBQUMsU0FBaUI7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssRUFBRTtZQUNULEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUN6QjtJQUNILENBQUM7O2lIQXROVSxvQkFBb0I7cUhBQXBCLG9CQUFvQjsyRkFBcEIsb0JBQW9CO2tCQURoQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVSZXVzZVN0cmF0ZWd5LCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBEZXRhY2hlZFJvdXRlSGFuZGxlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi8uLi90cmFjZSc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IGRlc3Ryb3lDb21wb25lbnRSZWYsIGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQsIHBhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2wgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5cbmludGVyZmFjZSBDYWNoZUl0ZW0ge1xuICBrZXk6IHN0cmluZztcbiAgc3RhdGU6IERldGFjaGVkUm91dGVIYW5kbGU7XG4gIGlzTW9kYWw6IGJvb2xlYW47XG4gIG1hcmtlZEZvckRlbGV0aW9uPzogYm9vbGVhbjtcbn1cblxuY29uc3QgZ2V0U25hcHNob3RLZXkgPSBmdW5jdGlvbiAoc25hcHNob3Q6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBzdHJpbmcge1xuICByZXR1cm4gc25hcHNob3QucGF0aEZyb21Sb290LmpvaW4oJy0+Jyk7XG59O1xuXG4vKipcbiAqIERldGFjaGVkIHN0YXRlIGNhY2hlXG4gKi9cbmNsYXNzIERldGFjaGVkU3RhdGVDYWNoZSB7XG4gIHByaXZhdGUgY2FjaGUgPSBuZXcgQXJyYXk8Q2FjaGVJdGVtPigpO1xuXG4gIHB1YmxpYyBnZXQgbGVuZ3RoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUubGVuZ3RoO1xuICB9XG5cbiAgcHVibGljIHB1c2goY2FjaGVJdGVtOiBDYWNoZUl0ZW0pIHtcbiAgICB0aGlzLmNhY2hlLnB1c2goY2FjaGVJdGVtKTtcbiAgfVxuXG4gIHB1YmxpYyBwb3AoKTogQ2FjaGVJdGVtIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5wb3AoKTtcbiAgfVxuXG4gIHB1YmxpYyBwZWVrKCk6IENhY2hlSXRlbSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGVbdGhpcy5jYWNoZS5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhcigpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgRGV0YWNoZWRTdGF0ZUNhY2hlLmNsZWFyKCkgJHt0aGlzLmNhY2hlLmxlbmd0aH0gaXRlbXMgd2lsbCBiZSBkZXN0cm95ZWRgKTtcbiAgICB9XG5cbiAgICB3aGlsZSAodGhpcy5jYWNoZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBzdGF0ZSA9IDxhbnk+dGhpcy5jYWNoZS5wb3AoKS5zdGF0ZTtcbiAgICAgIGlmICghc3RhdGUuY29tcG9uZW50UmVmKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29tcG9uZW50UmVmIGZvdW5kIGluIERldGFjaGVkUm91dGVIYW5kbGUnKTtcbiAgICAgIH1cblxuICAgICAgZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZS5jb21wb25lbnRSZWYpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBtYXJrQ3VycmVudEZvckNsZWFyKCkge1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiB0aGlzLmNhY2hlKSB7XG4gICAgICBpdGVtLm1hcmtlZEZvckRlbGV0aW9uID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xlYXJNYXJrZWQoKSB7XG4gICAgLy8gdHJ5IHRvIHByZXNlcnZlIHNhbWUgb3JkZXIgYXMgLmNsZWFyKClcbiAgICBmb3IgKGxldCBpID0gdGhpcy5jYWNoZS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgY2FjaGVJdGVtID0gdGhpcy5jYWNoZVtpXTtcbiAgICAgIGlmIChjYWNoZUl0ZW0ubWFya2VkRm9yRGVsZXRpb24pIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSA8YW55PmNhY2hlSXRlbS5zdGF0ZTtcbiAgICAgICAgaWYgKCFzdGF0ZS5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudFJlZiBmb3VuZCBpbiBEZXRhY2hlZFJvdXRlSGFuZGxlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBkZXN0cm95Q29tcG9uZW50UmVmKHN0YXRlLmNvbXBvbmVudFJlZik7XG4gICAgICAgIHRoaXMuY2FjaGUuc3BsaWNlKGksIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjbGVhck1vZGFsQ2FjaGUoKSB7XG4gICAgbGV0IHJlbW92ZWRJdGVtc0NvdW50ID0gMDtcbiAgICBjb25zdCBoYXNNb2RhbFBhZ2VzID0gdGhpcy5jYWNoZS5zb21lKChjYWNoZUl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBjYWNoZUl0ZW0uaXNNb2RhbDtcbiAgICB9KTtcblxuICAgIGlmIChoYXNNb2RhbFBhZ2VzKSB7XG4gICAgICBsZXQgbW9kYWxDYWNoZUNsZWFyZWQgPSBmYWxzZTtcblxuICAgICAgd2hpbGUgKCFtb2RhbENhY2hlQ2xlYXJlZCkge1xuICAgICAgICBjb25zdCBjYWNoZUl0ZW0gPSB0aGlzLnBlZWsoKTtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSA8YW55PmNhY2hlSXRlbS5zdGF0ZTtcblxuICAgICAgICBpZiAoIXN0YXRlLmNvbXBvbmVudFJlZikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gY29tcG9uZW50UmVmIGZvdW5kIGluIERldGFjaGVkUm91dGVIYW5kbGUnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGUuY29tcG9uZW50UmVmKTtcbiAgICAgICAgaWYgKGNhY2hlSXRlbS5pc01vZGFsKSB7XG4gICAgICAgICAgbW9kYWxDYWNoZUNsZWFyZWQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wb3AoKTtcbiAgICAgICAgcmVtb3ZlZEl0ZW1zQ291bnQrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgRGV0YWNoZWRTdGF0ZUNhY2hlLmNsZWFyTW9kYWxDYWNoZSgpICR7cmVtb3ZlZEl0ZW1zQ291bnR9IGl0ZW1zIHdpbGwgYmUgZGVzdHJveWVkYCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogRGV0YWNoZXMgc3VidHJlZXMgbG9hZGVkIGluc2lkZSBQYWdlUm91dGVyT3V0bGV0IGluIGZvcndhcmQgbmF2aWdhdGlvblxuICogYW5kIHJlYXR0YWNoZXMgdGhlbSBvbiBiYWNrLlxuICogUmV1c2VzIHJvdXRlcyBhcyBsb25nIGFzIHRoZWlyIHJvdXRlIGNvbmZpZyBpcyB0aGUgc2FtZS5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5TUm91dGVSZXVzZVN0cmF0ZWd5IGltcGxlbWVudHMgUm91dGVSZXVzZVN0cmF0ZWd5IHtcbiAgcHJpdmF0ZSBjYWNoZUJ5T3V0bGV0OiB7IFtrZXk6IHN0cmluZ106IERldGFjaGVkU3RhdGVDYWNoZSB9ID0ge307XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhdGlvbjogTlNMb2NhdGlvblN0cmF0ZWd5KSB7fVxuXG4gIHNob3VsZERldGFjaChyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IGJvb2xlYW4ge1xuICAgIHJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChyb3V0ZSk7XG5cbiAgICBjb25zdCB7IG91dGxldCB9ID0gdGhpcy5maW5kVmFsaWRPdXRsZXRBbmRLZXkocm91dGUpO1xuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcblxuICAgIGxldCBpc1BhZ2VBY3RpdmF0ZWQgPSBmYWxzZTtcbiAgICBsZXQgdG1wID0gcm91dGU7XG4gICAgd2hpbGUgKCEoaXNQYWdlQWN0aXZhdGVkID0gdG1wW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdKSAmJiB0bXAucGFyZW50KSB7XG4gICAgICB0bXAgPSB0bXAucGFyZW50O1xuICAgIH1cbiAgICBjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcbiAgICBsZXQgc2hvdWxkRGV0YWNoID0gb3V0bGV0ICYmICFpc0JhY2sgJiYgaXNQYWdlQWN0aXZhdGVkO1xuXG4gICAgaWYgKG91dGxldCkge1xuICAgICAgaWYgKG91dGxldC5wYXJlbnQgJiYgIW91dGxldC5wYXJlbnQuc2hvdWxkRGV0YWNoKSB7XG4gICAgICAgIHNob3VsZERldGFjaCA9IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBvdXRsZXQuc2hvdWxkRGV0YWNoID0gc2hvdWxkRGV0YWNoO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGREZXRhY2ggaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gcmVzdWx0OiAke3Nob3VsZERldGFjaH1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkRGV0YWNoO1xuICB9XG4gIHByb3RlY3RlZCBmaW5kVmFsaWRPdXRsZXRBbmRLZXkodGFyZ2V0Um91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpIHtcbiAgICBsZXQgcm91dGUgPSB0YXJnZXRSb3V0ZTtcbiAgICBjb25zdCByb3V0ZU91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgbGV0IG91dGxldEtleSA9IHJvdXRlT3V0bGV0S2V5O1xuICAgIGxldCBvdXRsZXQgPSB0aGlzLmxvY2F0aW9uLmZpbmRPdXRsZXQob3V0bGV0S2V5LCByb3V0ZSk7XG4gICAgd2hpbGUgKCFvdXRsZXQpIHtcbiAgICAgIGlmICghcm91dGUucGFyZW50KSB7XG4gICAgICAgIHJldHVybiB7IG91dGxldDogbnVsbCwgb3V0bGV0S2V5OiByb3V0ZU91dGxldEtleSB9O1xuICAgICAgfVxuICAgICAgcm91dGUgPSByb3V0ZS5wYXJlbnQ7XG4gICAgICBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uLmdldFJvdXRlRnVsbFBhdGgocm91dGUpO1xuICAgICAgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuICAgIH1cblxuICAgIGlmIChvdXRsZXQpIHtcbiAgICAgIHdoaWxlICghb3V0bGV0Lm91dGxldEtleXMuaW5jbHVkZXMob3V0bGV0S2V5KSkge1xuICAgICAgICBpZiAoIXJvdXRlLnBhcmVudCkge1xuICAgICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgQ291bGQgbm90IGZpbmQgdmFsaWQgb3V0bGV0IGtleSBmb3Igcm91dGU6ICR7dGFyZ2V0Um91dGV9LmApO1xuICAgICAgICAgIHJldHVybiB7IG91dGxldCwgb3V0bGV0S2V5OiByb3V0ZU91dGxldEtleSB9O1xuICAgICAgICB9XG4gICAgICAgIHJvdXRlID0gcm91dGUucGFyZW50O1xuICAgICAgICBvdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uLmdldFJvdXRlRnVsbFBhdGgocm91dGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IG91dGxldCwgb3V0bGV0S2V5IH07XG4gIH1cblxuICBzaG91bGRBdHRhY2gocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICByb3V0ZSA9IGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQocm91dGUpO1xuXG4gICAgY29uc3QgeyBvdXRsZXQsIG91dGxldEtleSB9ID0gdGhpcy5maW5kVmFsaWRPdXRsZXRBbmRLZXkocm91dGUpO1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG4gICAgaWYgKCFjYWNoZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcbiAgICBjb25zdCBzaG91bGRBdHRhY2ggPSBpc0JhY2sgJiYgY2FjaGUucGVlaygpPy5rZXkgPT09IGtleTtcblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGRBdHRhY2ggaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gcmVzdWx0OiAke3Nob3VsZEF0dGFjaH1gKTtcbiAgICB9XG5cbiAgICBpZiAob3V0bGV0KSB7XG4gICAgICBvdXRsZXQuc2hvdWxkRGV0YWNoID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkQXR0YWNoO1xuICB9XG5cbiAgc3RvcmUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBEZXRhY2hlZFJvdXRlSGFuZGxlKTogdm9pZCB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgc3RvcmUga2V5OiAke2tleX0sIHN0YXRlOiAke3N0YXRlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHsgb3V0bGV0S2V5IH0gPSB0aGlzLmZpbmRWYWxpZE91dGxldEFuZEtleShyb3V0ZSk7XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgY29uc3QgY2FjaGUgPSAodGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV0gPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XSB8fCBuZXcgRGV0YWNoZWRTdGF0ZUNhY2hlKCkpO1xuXG4gICAgaWYgKHN0YXRlKSB7XG4gICAgICBsZXQgaXNNb2RhbCA9IGZhbHNlO1xuICAgICAgaWYgKHRoaXMubG9jYXRpb24uX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMCkge1xuICAgICAgICBpc01vZGFsID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgY2FjaGUucHVzaCh7IGtleSwgc3RhdGUsIGlzTW9kYWwgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRvcEl0ZW0gPSBjYWNoZS5wZWVrKCk7XG4gICAgICBpZiAodG9wSXRlbS5rZXkgPT09IGtleSkge1xuICAgICAgICBjYWNoZS5wb3AoKTtcblxuICAgICAgICBpZiAoIWNhY2hlLmxlbmd0aCkge1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVHJ5aW5nIHRvIHBvcCBmcm9tIERldGFjaGVkU3RhdGVDYWNoZSBidXQga2V5cyBkb24ndCBtYXRjaC4gXCIgKyBgZXhwZWN0ZWQ6ICR7dG9wSXRlbS5rZXl9IGFjdHVhbDogJHtrZXl9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0cmlldmUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBEZXRhY2hlZFJvdXRlSGFuZGxlIHwgbnVsbCB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IHsgb3V0bGV0LCBvdXRsZXRLZXkgfSA9IHRoaXMuZmluZFZhbGlkT3V0bGV0QW5kS2V5KHJvdXRlKTtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuICAgIGlmICghY2FjaGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcbiAgICBjb25zdCBjYWNoZWRJdGVtID0gY2FjaGUucGVlaygpO1xuXG4gICAgbGV0IHN0YXRlID0gbnVsbDtcbiAgICBpZiAoaXNCYWNrICYmIGNhY2hlZEl0ZW0gJiYgY2FjaGVkSXRlbS5rZXkgPT09IGtleSkge1xuICAgICAgc3RhdGUgPSBjYWNoZWRJdGVtLnN0YXRlO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGByZXRyaWV2ZWQgaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gc3RhdGU6ICR7c3RhdGV9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgc2hvdWxkUmV1c2VSb3V0ZShmdXR1cmU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIGN1cnI6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICBjb25zdCBzaG91bGRSZXVzZSA9IGZ1dHVyZS5yb3V0ZUNvbmZpZyA9PT0gY3Vyci5yb3V0ZUNvbmZpZztcblxuICAgIGlmIChzaG91bGRSZXVzZSAmJiBjdXJyICYmIGN1cnJbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0pIHtcbiAgICAgIC8vIFdoZW4gcmV1c2luZyByb3V0ZSAtIGNvcHkgdGhlIHBhZ2VSb3V0ZXJBY3RpdmF0ZWQgdG8gdGhlIG5ldyBzbmFwc2hvdFxuICAgICAgLy8gSXQncyBuZWVkZWQgaW4gc2hvdWxkRGV0YWNoIHRvIGRldGVybWluZSBpZiB0aGUgcm91dGUgc2hvdWxkIGJlIGRldGFjaGVkLlxuICAgICAgZnV0dXJlW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdID0gY3VycltwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXTtcbiAgICB9XG5cbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgc2hvdWxkUmV1c2VSb3V0ZSByZXN1bHQ6ICR7c2hvdWxkUmV1c2V9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZFJldXNlO1xuICB9XG5cbiAgY2xlYXJDYWNoZShvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGNhY2hlLmNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgbWFya0NhY2hlRm9yQ2xlYXIob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjYWNoZS5tYXJrQ3VycmVudEZvckNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgcG9wQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBpZiAoY2FjaGUucGVlaygpKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlOiBhbnkgPSBjYWNoZS5wb3AoKT8uc3RhdGU7XG4gICAgICAgIGlmIChzdGF0ZT8uY29tcG9uZW50UmVmKSB7XG4gICAgICAgICAgZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZT8uY29tcG9uZW50UmVmKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG1hcmtDYWNoZUZvclBvcChvdXRsZXRLZXk6IHN0cmluZykge1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG5cbiAgICBpZiAoY2FjaGUpIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSBjYWNoZS5wZWVrKCk7XG4gICAgICBpZiAoaXRlbSkge1xuICAgICAgICBpdGVtLm1hcmtlZEZvckRlbGV0aW9uID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjbGVhck1hcmtlZENhY2hlKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY2FjaGUuY2xlYXJNYXJrZWQoKTtcbiAgICB9XG4gIH1cblxuICBjbGVhck1vZGFsQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjYWNoZS5jbGVhck1vZGFsQ2FjaGUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==