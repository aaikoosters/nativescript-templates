import { unsetValue } from '@nativescript/core';
import { getViewClass, getViewMeta, isKnownView } from './element-registry';
import { CommentNode, isContentView, isDetachedElement, isInvisibleNode, isLayout, isView, TextNode } from './views';
import { NativeScriptDebug } from './trace';
// Note: this utility exists from deep core import however results in
// Module not found: Error: Can't resolve '@nativescript/core/ui/core/properties'
function isCssVariable(property) {
    return /^--[^,\s]+?$/.test(property);
}
const ELEMENT_NODE_TYPE = 1;
const XML_ATTRIBUTES = Object.freeze(['style', 'rows', 'columns', 'fontAttributes']);
const whiteSpaceSplitter = /\s+/;
function printNgTree(view) {
    let parent = view;
    while (parent.parent && parent.parent.firstChild) {
        parent = parent.parent;
    }
    printChildrenRecurse(parent);
}
function printChildrenRecurse(parent) {
    const children = parent.firstChild ? [parent.firstChild, ...getChildrenSiblings(parent.firstChild).nextSiblings] : [];
    console.log(`parent: ${parent}, firstChild: ${parent.firstChild}, lastChild: ${parent.lastChild} children: ${children}`);
    if (parent.firstChild) {
        console.log(`----- start ${parent}`);
    }
    children.forEach((c) => printChildrenRecurse(c));
    if (parent.firstChild) {
        console.log(`----- end ${parent}`);
    }
}
function getChildrenSiblings(view) {
    const nextSiblings = [];
    const previousSiblings = [];
    let sibling = view.nextSibling;
    while (sibling) {
        nextSiblings.push(sibling);
        sibling = sibling.nextSibling;
    }
    sibling = view.previousSibling;
    while (sibling) {
        previousSiblings.push(sibling);
        sibling = sibling.previousSibling;
    }
    return {
        previousSiblings,
        nextSiblings,
    };
}
function printSiblingsTree(view) {
    const { previousSiblings, nextSiblings } = getChildrenSiblings(view);
    console.log(`${view} previousSiblings: ${previousSiblings} nextSiblings: ${nextSiblings}`);
}
// eslint-disable-next-line @typescript-eslint/ban-types
const propertyMaps = new Map();
export class ViewUtil {
    constructor(namespaceFilters, reuseViews) {
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
    }
    /**
     * Inserts a child into a parrent, preferably before next.
     * @param parent parent view
     * @param child child view to be added
     * @param previous previous element. If present, insert after this.
     * @param next next element. If present, insert before this (previous is ignored).
     */
    insertChild(parent, child, previous, next) {
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        // this should never enter, as angular is supposed to remove the child from the previous parent before calling this
        // but when angular animations are enabled, the removal might be delayed, so we need to ensure this view is not anywhere
        // this seems to only happens to CommentNodes
        if (extendedChild.parentNode) {
            this.removeChild(extendedChild.parentNode, extendedChild);
        }
        // if there's a next child, previous is the previousSibling of it
        if (next) {
            previous = next.previousSibling;
        }
        else if (previous) {
            // if there's a previous, next is the nextSibling of it
            next = previous.nextSibling;
        }
        else {
            // no previous or next, append to the parent
            previous = extendedParent.lastChild; // this can still be undefined if the parent has no children!
        }
        this.insertInList(extendedParent, extendedChild, previous, next);
        if (isDetachedElement(child) || isInvisibleNode(child)) {
            extendedChild.parentNode = extendedParent;
        }
        if (!isDetachedElement(child)) {
            const nextVisual = this.findNextVisual(next);
            this.addToVisualTree(extendedParent, extendedChild, nextVisual);
        }
        else if (isInvisibleNode(extendedChild)) {
            const nextVisual = this.findNextVisual(next);
            this.addInvisibleNode(extendedParent, extendedChild, nextVisual);
        }
        // printNgTree(extendedChild);
    }
    insertBefore(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, undefined, extendedRef);
    }
    insertAfter(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, extendedRef);
    }
    appendChild(parent, child) {
        this.insertChild(parent, child);
    }
    /**
     * Inserts a view into the parent/sibling linked list
     * !WARNING: this method makes no checks to validate the integrity of previous/next children
     * @param parent parent view
     * @param child child view
     * @param previous previous element. null/undefined for first element
     * @param next next element. null/undefined for last element
     */
    insertInList(parent, child, previous, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.insertInList parent: ${parent}, view: ${child}, ` + `previous: ${previous}, next: ${next}`);
        }
        if (previous) {
            previous.nextSibling = child;
            child.previousSibling = previous;
        }
        else {
            parent.firstChild = child;
        }
        if (next) {
            child.nextSibling = next;
            next.previousSibling = child;
        }
        else {
            parent.lastChild = child;
        }
    }
    addToVisualTree(parent, child, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToVisualTree parent: ${parent}, view: ${child}, next: ${next}`);
        }
        if (parent.meta && parent.meta.insertChild) {
            parent.meta.insertChild(parent, child, next);
        }
        else if (isLayout(parent)) {
            this.insertToLayout(parent, child, next);
        }
        else if (isContentView(parent)) {
            parent.content = child;
        }
        else if (parent && parent._addChildFromBuilder) {
            parent._addChildFromBuilder(child.nodeName, child);
        }
    }
    addInvisibleNode(parent, child, next) {
        if (parent.meta?.insertInvisibleNode) {
            parent.meta.insertInvisibleNode(parent, child, next);
        }
        else {
            if (child instanceof TextNode) {
                parent.text = child.text;
                child.registerTextChange((t) => (parent.text = t), parent);
            }
        }
    }
    insertToLayout(parent, child, next) {
        if (child.parent === parent) {
            this.removeLayoutChild(parent, child);
        }
        const nextVisual = this.findNextVisual(next);
        if (nextVisual) {
            const index = parent.getChildIndex(nextVisual);
            parent.insertChild(child, index);
        }
        else {
            parent.addChild(child);
        }
        // parent.eachChild((c) => {console.log(c); return true});
    }
    findNextVisual(view) {
        let next = view;
        while (next && isDetachedElement(next)) {
            next = next.nextSibling;
        }
        return next;
    }
    removeChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeChild parent: ${parent} child: ${child}`);
        }
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        extendedChild.parentNode = null;
        this.removeFromList(extendedParent, extendedChild);
        if (!isDetachedElement(extendedChild)) {
            this.removeFromVisualTree(extendedParent, extendedChild);
        }
        else if (isInvisibleNode(extendedChild)) {
            this.removeInvisibleNode(extendedParent, extendedChild);
        }
    }
    removeFromList(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromList parent: ${parent} child: ${child}`);
        }
        // only child. null everything
        if (parent.firstChild === child && parent.lastChild === child) {
            parent.firstChild = null;
            parent.lastChild = null;
            child.nextSibling = null;
            child.previousSibling = null;
            return;
        }
        const previous = child.previousSibling;
        const next = child.nextSibling;
        // is first child, make the next sibling the first child (can be null)
        if (parent.firstChild === child) {
            parent.firstChild = next;
        }
        // is last child, make the previous sibling the last child (can be null)
        if (parent.lastChild === child) {
            parent.lastChild = previous;
        }
        // we have a previous sibling, make it point to the next sibling
        if (previous) {
            previous.nextSibling = next;
        }
        // we have a next sibling, make it point to the previous
        if (next) {
            next.previousSibling = previous;
        }
        // finally, null the siblings
        child.nextSibling = null;
        child.previousSibling = null;
    }
    // NOTE: This one is O(n) - use carefully
    findPreviousElement(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.findPreviousElement parent: ${parent} child: ${child}`);
        }
        let previousVisual;
        if (isLayout(parent)) {
            previousVisual = this.getPreviousVisualElement(parent, child);
        }
        let previous = previousVisual || parent.firstChild;
        // since detached elements are not added to the visual tree,
        // we need to find the actual previous sibling of the view,
        // which may as well be an invisible node
        while (previous && previous !== child && previous.nextSibling !== child) {
            previous = previous.nextSibling;
        }
        return previous;
    }
    getPreviousVisualElement(parent, child) {
        const elementIndex = parent.getChildIndex(child);
        if (elementIndex > 0) {
            return parent.getChildAt(elementIndex - 1);
        }
    }
    // NOTE: This one is O(n) - use carefully
    getChildIndex(parent, child) {
        if (isLayout(parent)) {
            return parent.getChildIndex(child);
        }
        else if (isContentView(parent)) {
            return child === parent.content ? 0 : -1;
        }
    }
    removeFromVisualTree(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromVisualTree parent: ${parent} child: ${child}`);
        }
        if (parent.meta && parent.meta.removeChild) {
            parent.meta.removeChild(parent, child);
        }
        else if (isLayout(parent)) {
            this.removeLayoutChild(parent, child);
        }
        else if (isContentView(parent) && parent.content === child) {
            parent.content = null;
        }
        else if (isView(parent)) {
            parent._removeView(child);
        }
    }
    removeInvisibleNode(parent, child) {
        if (parent.meta?.removeInvisibleNode) {
            parent.meta.removeInvisibleNode(parent, child);
        }
        else {
            if (child instanceof TextNode) {
                child.unregisterTextChange(parent);
            }
        }
    }
    removeLayoutChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeLayoutChild parent: ${parent} child: ${child}`);
        }
        const index = parent.getChildIndex(child);
        if (index !== -1) {
            parent.removeChild(child);
        }
    }
    createComment(value) {
        return new CommentNode(value);
    }
    createText(value) {
        return new TextNode(value);
    }
    createView(name) {
        const originalName = name;
        if (!isKnownView(name)) {
            name = 'ProxyViewContainer';
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Creating view: ${originalName} ${name}`);
        }
        const viewClass = getViewClass(name);
        const view = new viewClass();
        const ngView = this.setNgViewExtensions(view, name);
        ngView.reusable = !!this.reuseViews;
        return ngView;
    }
    ensureNgViewExtensions(view) {
        if (Object.hasOwnProperty.call(view, 'meta')) {
            return view;
        }
        else {
            const name = view.cssType || view.typeName;
            const ngView = this.setNgViewExtensions(view, name);
            return ngView;
        }
    }
    setNgViewExtensions(view, name) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Make into a NgView view: ${view} name: "${name}"`);
        }
        const ngView = view;
        ngView.nodeName = name;
        ngView.meta = getViewMeta(name);
        // we're setting the node type of the view
        // to 'element' because of checks done in the
        // dom animation engine
        ngView.nodeType = ELEMENT_NODE_TYPE;
        return ngView;
    }
    setProperty(view, attributeName, value, namespace) {
        if (!view || (namespace && !this.runsIn(namespace))) {
            return;
        }
        if (attributeName.indexOf('.') !== -1) {
            // Handle nested properties
            const properties = attributeName.split('.');
            attributeName = properties[properties.length - 1];
            let propMap = this.getProperties(view);
            let i = 0;
            while (i < properties.length - 1 && typeof view !== 'undefined') {
                let prop = properties[i];
                if (propMap.has(prop)) {
                    prop = propMap.get(prop);
                }
                view = view[prop];
                propMap = this.getProperties(view);
                i++;
            }
        }
        if (typeof view !== 'undefined') {
            this.setPropertyInternal(view, attributeName, value);
        }
    }
    runsIn(platform) {
        let runs = true;
        const last = () => true;
        if (this.namespaceFilters) {
            let chain = (p) => true;
            for (let i = this.namespaceFilters.length - 1; i >= 0; i--) {
                const currentChain = chain;
                chain = (p) => this.namespaceFilters[i].runsIn(p, currentChain);
            }
            runs = chain(platform);
            runs = runs !== false ? true : false; // undefined means true
            // this.namespaceFilters.some((filter) => {
            // 	const runsInFilter = filter.runsIn(platform);
            // 	if (runsInFilter !== undefined) {
            // 		runs = runsInFilter;
            // 		return true;
            // 	}
            // });
        }
        return runs;
    }
    setPropertyInternal(view, attributeName, value) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Setting attribute: ${attributeName}=${value} to ${view}`);
        }
        if (attributeName === 'class') {
            this.setClasses(view, value);
            return;
        }
        if (XML_ATTRIBUTES.indexOf(attributeName) !== -1) {
            view[attributeName] = value;
            return;
        }
        const propMap = this.getProperties(view);
        const propertyName = propMap.get(attributeName);
        // Ensure the children of a collection currently have no parent set.
        if (Array.isArray(value)) {
            this.removeParentReferencesFromItems(value);
        }
        if (propertyName) {
            // We have a lower-upper case mapped property.
            view[propertyName] = value;
            return;
        }
        // Unknown attribute value -- just set it to our object as is.
        view[attributeName] = value;
    }
    removeParentReferencesFromItems(items) {
        for (const item of items) {
            if (item.parent && item.parentNode) {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.viewUtilLog(`Unassigning parent ${item.parentNode} on value: ${item}`);
                }
                item.parent = undefined;
                item.parentNode = undefined;
            }
        }
    }
    getProperties(instance) {
        const type = instance && instance.constructor;
        if (!type) {
            return new Map();
        }
        if (!propertyMaps.has(type)) {
            const propMap = new Map();
            for (const propName in instance) {
                // tslint:disable:forin
                propMap.set(propName.toLowerCase(), propName);
            }
            propertyMaps.set(type, propMap);
        }
        return propertyMaps.get(type);
    }
    cssClasses(view) {
        if (!view.ngCssClasses) {
            view.ngCssClasses = new Map();
        }
        return view.ngCssClasses;
    }
    addClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).set(className, true);
        this.syncClasses(extendedView);
    }
    removeClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).delete(className);
        this.syncClasses(extendedView);
    }
    setClasses(view, classesValue) {
        const classes = classesValue.split(whiteSpaceSplitter);
        this.cssClasses(view).clear();
        classes.forEach((className) => this.cssClasses(view).set(className, true));
        this.syncClasses(view);
    }
    syncClasses(view) {
        const classValue = Array.from(this.cssClasses(view).keys()).join(' ');
        view.className = classValue;
    }
    setStyle(view, styleName, value) {
        if (isCssVariable(styleName)) {
            view.style.setUnscopedCssVariable(styleName, value);
            view._onCssStateChange();
        }
        else {
            view.style[styleName] = value;
        }
    }
    removeStyle(view, styleName) {
        if (isCssVariable(styleName)) {
            // TODO: expose this on core
            view.style.unscopedCssVariables.delete(styleName);
            view._onCssStateChange();
        }
        else {
            view.style[styleName] = unsetValue;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhci9zcmMvbGliL3ZpZXctdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFRLE1BQU0sb0JBQW9CLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFNUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQVUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTdILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUc1QyxxRUFBcUU7QUFDckUsaUZBQWlGO0FBQ2pGLFNBQVMsYUFBYSxDQUFDLFFBQWdCO0lBQ3JDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLENBQUM7QUFDNUIsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztBQUNyRixNQUFNLGtCQUFrQixHQUFHLEtBQUssQ0FBQztBQUlqQyxTQUFTLFdBQVcsQ0FBQyxJQUFZO0lBQy9CLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQztJQUNsQixPQUFPLE1BQU0sQ0FBQyxNQUFNLElBQUssTUFBTSxDQUFDLE1BQWlCLENBQUMsVUFBVSxFQUFFO1FBQzVELE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBZ0IsQ0FBQztLQUNsQztJQUNELG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQy9CLENBQUM7QUFDRCxTQUFTLG9CQUFvQixDQUFDLE1BQWM7SUFD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QUFDLENBQUM7WUFDM0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7U0FDMUI7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsVUFBVSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdW5zZXRWYWx1ZSwgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBnZXRWaWV3Q2xhc3MsIGdldFZpZXdNZXRhLCBpc0tub3duVmlldyB9IGZyb20gJy4vZWxlbWVudC1yZWdpc3RyeSc7XG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIgfSBmcm9tICcuL3Byb3BlcnR5LWZpbHRlcic7XG5pbXBvcnQgeyBDb21tZW50Tm9kZSwgaXNDb250ZW50VmlldywgaXNEZXRhY2hlZEVsZW1lbnQsIGlzSW52aXNpYmxlTm9kZSwgaXNMYXlvdXQsIGlzVmlldywgTmdWaWV3LCBUZXh0Tm9kZSB9IGZyb20gJy4vdmlld3MnO1xuXG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4vdHJhY2UnO1xuaW1wb3J0IHsgTmdMYXlvdXRCYXNlIH0gZnJvbSAnLi92aWV3cy92aWV3LXR5cGVzJztcblxuLy8gTm90ZTogdGhpcyB1dGlsaXR5IGV4aXN0cyBmcm9tIGRlZXAgY29yZSBpbXBvcnQgaG93ZXZlciByZXN1bHRzIGluXG4vLyBNb2R1bGUgbm90IGZvdW5kOiBFcnJvcjogQ2FuJ3QgcmVzb2x2ZSAnQG5hdGl2ZXNjcmlwdC9jb3JlL3VpL2NvcmUvcHJvcGVydGllcydcbmZ1bmN0aW9uIGlzQ3NzVmFyaWFibGUocHJvcGVydHk6IHN0cmluZykge1xuICByZXR1cm4gL14tLVteLFxcc10rPyQvLnRlc3QocHJvcGVydHkpO1xufVxuXG5jb25zdCBFTEVNRU5UX05PREVfVFlQRSA9IDE7XG5jb25zdCBYTUxfQVRUUklCVVRFUyA9IE9iamVjdC5mcmVlemUoWydzdHlsZScsICdyb3dzJywgJ2NvbHVtbnMnLCAnZm9udEF0dHJpYnV0ZXMnXSk7XG5jb25zdCB3aGl0ZVNwYWNlU3BsaXR0ZXIgPSAvXFxzKy87XG5cbmV4cG9ydCB0eXBlIEJlZm9yZUF0dGFjaEFjdGlvbiA9ICh2aWV3OiBWaWV3KSA9PiB2b2lkO1xuXG5mdW5jdGlvbiBwcmludE5nVHJlZSh2aWV3OiBOZ1ZpZXcpIHtcbiAgbGV0IHBhcmVudCA9IHZpZXc7XG4gIHdoaWxlIChwYXJlbnQucGFyZW50ICYmIChwYXJlbnQucGFyZW50IGFzIE5nVmlldykuZmlyc3RDaGlsZCkge1xuICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQgYXMgTmdWaWV3O1xuICB9XG4gIHByaW50Q2hpbGRyZW5SZWN1cnNlKHBhcmVudCk7XG59XG5mdW5jdGlvbiBwcmludENoaWxkcmVuUmVjdXJzZShwYXJlbnQ6IE5nVmlldykge1xuICBjb25zdCBjaGlsZHJlbiA9IHBhcmVudC5maXJzdENoaWxkID8gW3BhcmVudC5maXJzdENoaWxkLCAuLi5nZXRDaGlsZHJlblNpYmxpbmdzKHBhcmVudC5maXJzdENoaWxkKS5uZXh0U2libGluZ3NdIDogW107XG4gIGNvbnNvbGUubG9nKGBwYXJlbnQ6ICR7cGFyZW50fSwgZmlyc3RDaGlsZDogJHtwYXJlbnQuZmlyc3RDaGlsZH0sIGxhc3RDaGlsZDogJHtwYXJlbnQubGFzdENoaWxkfSBjaGlsZHJlbjogJHtjaGlsZHJlbn1gKTtcbiAgaWYgKHBhcmVudC5maXJzdENoaWxkKSB7XG4gICAgY29uc29sZS5sb2coYC0tLS0tIHN0YXJ0ICR7cGFyZW50fWApO1xuICB9XG4gIGNoaWxkcmVuLmZvckVhY2goKGMpID0+IHByaW50Q2hpbGRyZW5SZWN1cnNlKGMpKTtcbiAgaWYgKHBhcmVudC5maXJzdENoaWxkKSB7XG4gICAgY29uc29sZS5sb2coYC0tLS0tIGVuZCAke3BhcmVudH1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDaGlsZHJlblNpYmxpbmdzKHZpZXc6IE5nVmlldykge1xuICBjb25zdCBuZXh0U2libGluZ3MgPSBbXTtcbiAgY29uc3QgcHJldmlvdXNTaWJsaW5ncyA9IFtdO1xuICBsZXQgc2libGluZyA9IHZpZXcubmV4dFNpYmxpbmc7XG4gIHdoaWxlIChzaWJsaW5nKSB7XG4gICAgbmV4dFNpYmxpbmdzLnB1c2goc2libGluZyk7XG4gICAgc2libGluZyA9IHNpYmxpbmcubmV4dFNpYmxpbmc7XG4gIH1cbiAgc2libGluZyA9IHZpZXcucHJldmlvdXNTaWJsaW5nO1xuICB3aGlsZSAoc2libGluZykge1xuICAgIHByZXZpb3VzU2libGluZ3MucHVzaChzaWJsaW5nKTtcbiAgICBzaWJsaW5nID0gc2libGluZy5wcmV2aW91c1NpYmxpbmc7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwcmV2aW91c1NpYmxpbmdzLFxuICAgIG5leHRTaWJsaW5ncyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gcHJpbnRTaWJsaW5nc1RyZWUodmlldzogTmdWaWV3KSB7XG4gIGNvbnN0IHsgcHJldmlvdXNTaWJsaW5ncywgbmV4dFNpYmxpbmdzIH0gPSBnZXRDaGlsZHJlblNpYmxpbmdzKHZpZXcpO1xuICBjb25zb2xlLmxvZyhgJHt2aWV3fSBwcmV2aW91c1NpYmxpbmdzOiAke3ByZXZpb3VzU2libGluZ3N9IG5leHRTaWJsaW5nczogJHtuZXh0U2libGluZ3N9YCk7XG59XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXR5cGVzXG5jb25zdCBwcm9wZXJ0eU1hcHM6IE1hcDxGdW5jdGlvbiwgTWFwPHN0cmluZywgc3RyaW5nPj4gPSBuZXcgTWFwPEZ1bmN0aW9uLCBNYXA8c3RyaW5nLCBzdHJpbmc+PigpO1xuXG5leHBvcnQgY2xhc3MgVmlld1V0aWwge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnM/OiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByZXVzZVZpZXdzPzogYm9vbGVhbikge31cbiAgLyoqXG4gICAqIEluc2VydHMgYSBjaGlsZCBpbnRvIGEgcGFycmVudCwgcHJlZmVyYWJseSBiZWZvcmUgbmV4dC5cbiAgICogQHBhcmFtIHBhcmVudCBwYXJlbnQgdmlld1xuICAgKiBAcGFyYW0gY2hpbGQgY2hpbGQgdmlldyB0byBiZSBhZGRlZFxuICAgKiBAcGFyYW0gcHJldmlvdXMgcHJldmlvdXMgZWxlbWVudC4gSWYgcHJlc2VudCwgaW5zZXJ0IGFmdGVyIHRoaXMuXG4gICAqIEBwYXJhbSBuZXh0IG5leHQgZWxlbWVudC4gSWYgcHJlc2VudCwgaW5zZXJ0IGJlZm9yZSB0aGlzIChwcmV2aW91cyBpcyBpZ25vcmVkKS5cbiAgICovXG4gIHByaXZhdGUgaW5zZXJ0Q2hpbGQocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcHJldmlvdXM/OiBOZ1ZpZXcsIG5leHQ/OiBOZ1ZpZXcpIHtcbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dGVuZGVkUGFyZW50ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHBhcmVudCk7XG4gICAgY29uc3QgZXh0ZW5kZWRDaGlsZCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhjaGlsZCk7XG5cbiAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBlbnRlciwgYXMgYW5ndWxhciBpcyBzdXBwb3NlZCB0byByZW1vdmUgdGhlIGNoaWxkIGZyb20gdGhlIHByZXZpb3VzIHBhcmVudCBiZWZvcmUgY2FsbGluZyB0aGlzXG4gICAgLy8gYnV0IHdoZW4gYW5ndWxhciBhbmltYXRpb25zIGFyZSBlbmFibGVkLCB0aGUgcmVtb3ZhbCBtaWdodCBiZSBkZWxheWVkLCBzbyB3ZSBuZWVkIHRvIGVuc3VyZSB0aGlzIHZpZXcgaXMgbm90IGFueXdoZXJlXG4gICAgLy8gdGhpcyBzZWVtcyB0byBvbmx5IGhhcHBlbnMgdG8gQ29tbWVudE5vZGVzXG4gICAgaWYgKGV4dGVuZGVkQ2hpbGQucGFyZW50Tm9kZSkge1xuICAgICAgdGhpcy5yZW1vdmVDaGlsZChleHRlbmRlZENoaWxkLnBhcmVudE5vZGUsIGV4dGVuZGVkQ2hpbGQpO1xuICAgIH1cbiAgICAvLyBpZiB0aGVyZSdzIGEgbmV4dCBjaGlsZCwgcHJldmlvdXMgaXMgdGhlIHByZXZpb3VzU2libGluZyBvZiBpdFxuICAgIGlmIChuZXh0KSB7XG4gICAgICBwcmV2aW91cyA9IG5leHQucHJldmlvdXNTaWJsaW5nO1xuICAgIH0gZWxzZSBpZiAocHJldmlvdXMpIHtcbiAgICAgIC8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cywgbmV4dCBpcyB0aGUgbmV4dFNpYmxpbmcgb2YgaXRcbiAgICAgIG5leHQgPSBwcmV2aW91cy5uZXh0U2libGluZztcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm8gcHJldmlvdXMgb3IgbmV4dCwgYXBwZW5kIHRvIHRoZSBwYXJlbnRcbiAgICAgIHByZXZpb3VzID0gZXh0ZW5kZWRQYXJlbnQubGFzdENoaWxkOyAvLyB0aGlzIGNhbiBzdGlsbCBiZSB1bmRlZmluZWQgaWYgdGhlIHBhcmVudCBoYXMgbm8gY2hpbGRyZW4hXG4gICAgfVxuICAgIHRoaXMuaW5zZXJ0SW5MaXN0KGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkLCBwcmV2aW91cywgbmV4dCk7XG5cbiAgICBpZiAoaXNEZXRhY2hlZEVsZW1lbnQoY2hpbGQpIHx8IGlzSW52aXNpYmxlTm9kZShjaGlsZCkpIHtcbiAgICAgIGV4dGVuZGVkQ2hpbGQucGFyZW50Tm9kZSA9IGV4dGVuZGVkUGFyZW50O1xuICAgIH1cblxuICAgIGlmICghaXNEZXRhY2hlZEVsZW1lbnQoY2hpbGQpKSB7XG4gICAgICBjb25zdCBuZXh0VmlzdWFsID0gdGhpcy5maW5kTmV4dFZpc3VhbChuZXh0KTtcbiAgICAgIHRoaXMuYWRkVG9WaXN1YWxUcmVlKGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkLCBuZXh0VmlzdWFsKTtcbiAgICB9IGVsc2UgaWYgKGlzSW52aXNpYmxlTm9kZShleHRlbmRlZENoaWxkKSkge1xuICAgICAgY29uc3QgbmV4dFZpc3VhbCA9IHRoaXMuZmluZE5leHRWaXN1YWwobmV4dCk7XG4gICAgICB0aGlzLmFkZEludmlzaWJsZU5vZGUoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQsIG5leHRWaXN1YWwpO1xuICAgIH1cbiAgICAvLyBwcmludE5nVHJlZShleHRlbmRlZENoaWxkKTtcbiAgfVxuXG4gIHB1YmxpYyBpbnNlcnRCZWZvcmUocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcmVmQ2hpbGQ/OiBWaWV3IHwgTmdWaWV3KSB7XG4gICAgY29uc3QgZXh0ZW5kZWRSZWYgPSByZWZDaGlsZCA/IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhyZWZDaGlsZCkgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCB1bmRlZmluZWQsIGV4dGVuZGVkUmVmKTtcbiAgfVxuICBwdWJsaWMgaW5zZXJ0QWZ0ZXIocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcmVmQ2hpbGQ/OiBWaWV3IHwgTmdWaWV3KSB7XG4gICAgY29uc3QgZXh0ZW5kZWRSZWYgPSByZWZDaGlsZCA/IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhyZWZDaGlsZCkgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCBleHRlbmRlZFJlZik7XG4gIH1cblxuICBwdWJsaWMgYXBwZW5kQ2hpbGQocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldykge1xuICAgIHRoaXMuaW5zZXJ0Q2hpbGQocGFyZW50LCBjaGlsZCk7XG4gIH1cblxuICAvKipcbiAgICogSW5zZXJ0cyBhIHZpZXcgaW50byB0aGUgcGFyZW50L3NpYmxpbmcgbGlua2VkIGxpc3RcbiAgICogIVdBUk5JTkc6IHRoaXMgbWV0aG9kIG1ha2VzIG5vIGNoZWNrcyB0byB2YWxpZGF0ZSB0aGUgaW50ZWdyaXR5IG9mIHByZXZpb3VzL25leHQgY2hpbGRyZW5cbiAgICogQHBhcmFtIHBhcmVudCBwYXJlbnQgdmlld1xuICAgKiBAcGFyYW0gY2hpbGQgY2hpbGQgdmlld1xuICAgKiBAcGFyYW0gcHJldmlvdXMgcHJldmlvdXMgZWxlbWVudC4gbnVsbC91bmRlZmluZWQgZm9yIGZpcnN0IGVsZW1lbnRcbiAgICogQHBhcmFtIG5leHQgbmV4dCBlbGVtZW50LiBudWxsL3VuZGVmaW5lZCBmb3IgbGFzdCBlbGVtZW50XG4gICAqL1xuICBwcml2YXRlIGluc2VydEluTGlzdChwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldywgcHJldmlvdXM6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuaW5zZXJ0SW5MaXN0IHBhcmVudDogJHtwYXJlbnR9LCB2aWV3OiAke2NoaWxkfSwgYCArIGBwcmV2aW91czogJHtwcmV2aW91c30sIG5leHQ6ICR7bmV4dH1gKTtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXMpIHtcbiAgICAgIHByZXZpb3VzLm5leHRTaWJsaW5nID0gY2hpbGQ7XG4gICAgICBjaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91cztcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50LmZpcnN0Q2hpbGQgPSBjaGlsZDtcbiAgICB9XG5cbiAgICBpZiAobmV4dCkge1xuICAgICAgY2hpbGQubmV4dFNpYmxpbmcgPSBuZXh0O1xuICAgICAgbmV4dC5wcmV2aW91c1NpYmxpbmcgPSBjaGlsZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IGNoaWxkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9WaXN1YWxUcmVlKHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3LCBuZXh0OiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5hZGRUb1Zpc3VhbFRyZWUgcGFyZW50OiAke3BhcmVudH0sIHZpZXc6ICR7Y2hpbGR9LCBuZXh0OiAke25leHR9YCk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudC5tZXRhICYmIHBhcmVudC5tZXRhLmluc2VydENoaWxkKSB7XG4gICAgICBwYXJlbnQubWV0YS5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCBuZXh0KTtcbiAgICB9IGVsc2UgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHRoaXMuaW5zZXJ0VG9MYXlvdXQocGFyZW50LCBjaGlsZCwgbmV4dCk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnRlbnRWaWV3KHBhcmVudCkpIHtcbiAgICAgIHBhcmVudC5jb250ZW50ID0gY2hpbGQ7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgJiYgKDxhbnk+cGFyZW50KS5fYWRkQ2hpbGRGcm9tQnVpbGRlcikge1xuICAgICAgKDxhbnk+cGFyZW50KS5fYWRkQ2hpbGRGcm9tQnVpbGRlcihjaGlsZC5ub2RlTmFtZSwgY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkSW52aXNpYmxlTm9kZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKHBhcmVudC5tZXRhPy5pbnNlcnRJbnZpc2libGVOb2RlKSB7XG4gICAgICBwYXJlbnQubWV0YS5pbnNlcnRJbnZpc2libGVOb2RlKHBhcmVudCwgY2hpbGQsIG5leHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBUZXh0Tm9kZSkge1xuICAgICAgICAocGFyZW50IGFzIGFueSkudGV4dCA9IGNoaWxkLnRleHQ7XG4gICAgICAgIGNoaWxkLnJlZ2lzdGVyVGV4dENoYW5nZSgodCkgPT4gKChwYXJlbnQgYXMgYW55KS50ZXh0ID0gdCksIHBhcmVudCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRUb0xheW91dChwYXJlbnQ6IE5nTGF5b3V0QmFzZSwgY2hpbGQ6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKGNoaWxkLnBhcmVudCA9PT0gcGFyZW50KSB7XG4gICAgICB0aGlzLnJlbW92ZUxheW91dENoaWxkKHBhcmVudCwgY2hpbGQpO1xuICAgIH1cblxuICAgIGNvbnN0IG5leHRWaXN1YWwgPSB0aGlzLmZpbmROZXh0VmlzdWFsKG5leHQpO1xuICAgIGlmIChuZXh0VmlzdWFsKSB7XG4gICAgICBjb25zdCBpbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KG5leHRWaXN1YWwpO1xuICAgICAgcGFyZW50Lmluc2VydENoaWxkKGNoaWxkLCBpbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudC5hZGRDaGlsZChjaGlsZCk7XG4gICAgfVxuICAgIC8vIHBhcmVudC5lYWNoQ2hpbGQoKGMpID0+IHtjb25zb2xlLmxvZyhjKTsgcmV0dXJuIHRydWV9KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZE5leHRWaXN1YWwodmlldzogTmdWaWV3KTogTmdWaWV3IHtcbiAgICBsZXQgbmV4dCA9IHZpZXc7XG4gICAgd2hpbGUgKG5leHQgJiYgaXNEZXRhY2hlZEVsZW1lbnQobmV4dCkpIHtcbiAgICAgIG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0O1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUNoaWxkKHBhcmVudDogVmlldywgY2hpbGQ6IFZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVDaGlsZCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dGVuZGVkUGFyZW50ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHBhcmVudCk7XG4gICAgY29uc3QgZXh0ZW5kZWRDaGlsZCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhjaGlsZCk7XG4gICAgZXh0ZW5kZWRDaGlsZC5wYXJlbnROb2RlID0gbnVsbDtcblxuICAgIHRoaXMucmVtb3ZlRnJvbUxpc3QoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQpO1xuICAgIGlmICghaXNEZXRhY2hlZEVsZW1lbnQoZXh0ZW5kZWRDaGlsZCkpIHtcbiAgICAgIHRoaXMucmVtb3ZlRnJvbVZpc3VhbFRyZWUoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQpO1xuICAgIH0gZWxzZSBpZiAoaXNJbnZpc2libGVOb2RlKGV4dGVuZGVkQ2hpbGQpKSB7XG4gICAgICB0aGlzLnJlbW92ZUludmlzaWJsZU5vZGUoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRnJvbUxpc3QocGFyZW50OiBOZ1ZpZXcsIGNoaWxkOiBOZ1ZpZXcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVGcm9tTGlzdCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICAvLyBvbmx5IGNoaWxkLiBudWxsIGV2ZXJ5dGhpbmdcbiAgICBpZiAocGFyZW50LmZpcnN0Q2hpbGQgPT09IGNoaWxkICYmIHBhcmVudC5sYXN0Q2hpbGQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQuZmlyc3RDaGlsZCA9IG51bGw7XG4gICAgICBwYXJlbnQubGFzdENoaWxkID0gbnVsbDtcbiAgICAgIGNoaWxkLm5leHRTaWJsaW5nID0gbnVsbDtcbiAgICAgIGNoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXMgPSBjaGlsZC5wcmV2aW91c1NpYmxpbmc7XG4gICAgY29uc3QgbmV4dCA9IGNoaWxkLm5leHRTaWJsaW5nO1xuICAgIC8vIGlzIGZpcnN0IGNoaWxkLCBtYWtlIHRoZSBuZXh0IHNpYmxpbmcgdGhlIGZpcnN0IGNoaWxkIChjYW4gYmUgbnVsbClcbiAgICBpZiAocGFyZW50LmZpcnN0Q2hpbGQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQuZmlyc3RDaGlsZCA9IG5leHQ7XG4gICAgfVxuXG4gICAgLy8gaXMgbGFzdCBjaGlsZCwgbWFrZSB0aGUgcHJldmlvdXMgc2libGluZyB0aGUgbGFzdCBjaGlsZCAoY2FuIGJlIG51bGwpXG4gICAgaWYgKHBhcmVudC5sYXN0Q2hpbGQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQubGFzdENoaWxkID0gcHJldmlvdXM7XG4gICAgfVxuXG4gICAgLy8gd2UgaGF2ZSBhIHByZXZpb3VzIHNpYmxpbmcsIG1ha2UgaXQgcG9pbnQgdG8gdGhlIG5leHQgc2libGluZ1xuICAgIGlmIChwcmV2aW91cykge1xuICAgICAgcHJldmlvdXMubmV4dFNpYmxpbmcgPSBuZXh0O1xuICAgIH1cblxuICAgIC8vIHdlIGhhdmUgYSBuZXh0IHNpYmxpbmcsIG1ha2UgaXQgcG9pbnQgdG8gdGhlIHByZXZpb3VzXG4gICAgaWYgKG5leHQpIHtcbiAgICAgIG5leHQucHJldmlvdXNTaWJsaW5nID0gcHJldmlvdXM7XG4gICAgfVxuXG4gICAgLy8gZmluYWxseSwgbnVsbCB0aGUgc2libGluZ3NcbiAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7XG4gICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gbnVsbDtcbiAgfVxuXG4gIC8vIE5PVEU6IFRoaXMgb25lIGlzIE8obikgLSB1c2UgY2FyZWZ1bGx5XG4gIHByaXZhdGUgZmluZFByZXZpb3VzRWxlbWVudChwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuZmluZFByZXZpb3VzRWxlbWVudCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBsZXQgcHJldmlvdXNWaXN1YWw7XG4gICAgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHByZXZpb3VzVmlzdWFsID0gdGhpcy5nZXRQcmV2aW91c1Zpc3VhbEVsZW1lbnQocGFyZW50LCBjaGlsZCk7XG4gICAgfVxuXG4gICAgbGV0IHByZXZpb3VzID0gcHJldmlvdXNWaXN1YWwgfHwgcGFyZW50LmZpcnN0Q2hpbGQ7XG5cbiAgICAvLyBzaW5jZSBkZXRhY2hlZCBlbGVtZW50cyBhcmUgbm90IGFkZGVkIHRvIHRoZSB2aXN1YWwgdHJlZSxcbiAgICAvLyB3ZSBuZWVkIHRvIGZpbmQgdGhlIGFjdHVhbCBwcmV2aW91cyBzaWJsaW5nIG9mIHRoZSB2aWV3LFxuICAgIC8vIHdoaWNoIG1heSBhcyB3ZWxsIGJlIGFuIGludmlzaWJsZSBub2RlXG4gICAgd2hpbGUgKHByZXZpb3VzICYmIHByZXZpb3VzICE9PSBjaGlsZCAmJiBwcmV2aW91cy5uZXh0U2libGluZyAhPT0gY2hpbGQpIHtcbiAgICAgIHByZXZpb3VzID0gcHJldmlvdXMubmV4dFNpYmxpbmc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZXZpb3VzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcmV2aW91c1Zpc3VhbEVsZW1lbnQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuICAgIGNvbnN0IGVsZW1lbnRJbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KGNoaWxkKTtcblxuICAgIGlmIChlbGVtZW50SW5kZXggPiAwKSB7XG4gICAgICByZXR1cm4gcGFyZW50LmdldENoaWxkQXQoZWxlbWVudEluZGV4IC0gMSkgYXMgTmdWaWV3O1xuICAgIH1cbiAgfVxuXG4gIC8vIE5PVEU6IFRoaXMgb25lIGlzIE8obikgLSB1c2UgY2FyZWZ1bGx5XG4gIHB1YmxpYyBnZXRDaGlsZEluZGV4KHBhcmVudDogYW55LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHJldHVybiBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnRlbnRWaWV3KHBhcmVudCkpIHtcbiAgICAgIHJldHVybiBjaGlsZCA9PT0gcGFyZW50LmNvbnRlbnQgPyAwIDogLTE7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVGcm9tVmlzdWFsVHJlZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUZyb21WaXN1YWxUcmVlIHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQubWV0YSAmJiBwYXJlbnQubWV0YS5yZW1vdmVDaGlsZCkge1xuICAgICAgcGFyZW50Lm1ldGEucmVtb3ZlQ2hpbGQocGFyZW50LCBjaGlsZCk7XG4gICAgfSBlbHNlIGlmIChpc0xheW91dChwYXJlbnQpKSB7XG4gICAgICB0aGlzLnJlbW92ZUxheW91dENoaWxkKHBhcmVudCwgY2hpbGQpO1xuICAgIH0gZWxzZSBpZiAoaXNDb250ZW50VmlldyhwYXJlbnQpICYmIHBhcmVudC5jb250ZW50ID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50LmNvbnRlbnQgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAoaXNWaWV3KHBhcmVudCkpIHtcbiAgICAgIHBhcmVudC5fcmVtb3ZlVmlldyhjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVJbnZpc2libGVOb2RlKHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKHBhcmVudC5tZXRhPy5yZW1vdmVJbnZpc2libGVOb2RlKSB7XG4gICAgICBwYXJlbnQubWV0YS5yZW1vdmVJbnZpc2libGVOb2RlKHBhcmVudCwgY2hpbGQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBUZXh0Tm9kZSkge1xuICAgICAgICBjaGlsZC51bnJlZ2lzdGVyVGV4dENoYW5nZShwYXJlbnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTGF5b3V0Q2hpbGQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5yZW1vdmVMYXlvdXRDaGlsZCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KGNoaWxkKTtcblxuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNyZWF0ZUNvbW1lbnQodmFsdWU6IHN0cmluZyk6IENvbW1lbnROb2RlIHtcbiAgICByZXR1cm4gbmV3IENvbW1lbnROb2RlKHZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUZXh0KHZhbHVlOiBzdHJpbmcpOiBUZXh0Tm9kZSB7XG4gICAgcmV0dXJuIG5ldyBUZXh0Tm9kZSh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVmlldyhuYW1lOiBzdHJpbmcpOiBOZ1ZpZXcge1xuICAgIGNvbnN0IG9yaWdpbmFsTmFtZSA9IG5hbWU7XG4gICAgaWYgKCFpc0tub3duVmlldyhuYW1lKSkge1xuICAgICAgbmFtZSA9ICdQcm94eVZpZXdDb250YWluZXInO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYENyZWF0aW5nIHZpZXc6ICR7b3JpZ2luYWxOYW1lfSAke25hbWV9YCk7XG4gICAgfVxuXG4gICAgY29uc3Qgdmlld0NsYXNzID0gZ2V0Vmlld0NsYXNzKG5hbWUpO1xuICAgIGNvbnN0IHZpZXcgPSA8TmdWaWV3Pm5ldyB2aWV3Q2xhc3MoKTtcbiAgICBjb25zdCBuZ1ZpZXcgPSB0aGlzLnNldE5nVmlld0V4dGVuc2lvbnModmlldywgbmFtZSk7XG4gICAgbmdWaWV3LnJldXNhYmxlID0gISF0aGlzLnJldXNlVmlld3M7XG5cbiAgICByZXR1cm4gbmdWaWV3O1xuICB9XG5cbiAgcHJpdmF0ZSBlbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHZpZXc6IFZpZXcpOiBOZ1ZpZXcge1xuICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh2aWV3LCAnbWV0YScpKSB7XG4gICAgICByZXR1cm4gdmlldyBhcyBOZ1ZpZXc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB2aWV3LmNzc1R5cGUgfHwgdmlldy50eXBlTmFtZTtcbiAgICAgIGNvbnN0IG5nVmlldyA9IHRoaXMuc2V0TmdWaWV3RXh0ZW5zaW9ucyh2aWV3LCBuYW1lKTtcblxuICAgICAgcmV0dXJuIG5nVmlldztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldE5nVmlld0V4dGVuc2lvbnModmlldzogVmlldywgbmFtZTogc3RyaW5nKTogTmdWaWV3IHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBNYWtlIGludG8gYSBOZ1ZpZXcgdmlldzogJHt2aWV3fSBuYW1lOiBcIiR7bmFtZX1cImApO1xuICAgIH1cblxuICAgIGNvbnN0IG5nVmlldyA9IHZpZXcgYXMgTmdWaWV3O1xuICAgIG5nVmlldy5ub2RlTmFtZSA9IG5hbWU7XG4gICAgbmdWaWV3Lm1ldGEgPSBnZXRWaWV3TWV0YShuYW1lKTtcblxuICAgIC8vIHdlJ3JlIHNldHRpbmcgdGhlIG5vZGUgdHlwZSBvZiB0aGUgdmlld1xuICAgIC8vIHRvICdlbGVtZW50JyBiZWNhdXNlIG9mIGNoZWNrcyBkb25lIGluIHRoZVxuICAgIC8vIGRvbSBhbmltYXRpb24gZW5naW5lXG4gICAgbmdWaWV3Lm5vZGVUeXBlID0gRUxFTUVOVF9OT0RFX1RZUEU7XG5cbiAgICByZXR1cm4gbmdWaWV3O1xuICB9XG5cbiAgcHVibGljIHNldFByb3BlcnR5KHZpZXc6IE5nVmlldywgYXR0cmlidXRlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LCBuYW1lc3BhY2U/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXZpZXcgfHwgKG5hbWVzcGFjZSAmJiAhdGhpcy5ydW5zSW4obmFtZXNwYWNlKSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoYXR0cmlidXRlTmFtZS5pbmRleE9mKCcuJykgIT09IC0xKSB7XG4gICAgICAvLyBIYW5kbGUgbmVzdGVkIHByb3BlcnRpZXNcbiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBhdHRyaWJ1dGVOYW1lLnNwbGl0KCcuJyk7XG4gICAgICBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydGllc1twcm9wZXJ0aWVzLmxlbmd0aCAtIDFdO1xuXG4gICAgICBsZXQgcHJvcE1hcCA9IHRoaXMuZ2V0UHJvcGVydGllcyh2aWV3KTtcbiAgICAgIGxldCBpID0gMDtcbiAgICAgIHdoaWxlIChpIDwgcHJvcGVydGllcy5sZW5ndGggLSAxICYmIHR5cGVvZiB2aWV3ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBsZXQgcHJvcCA9IHByb3BlcnRpZXNbaV07XG4gICAgICAgIGlmIChwcm9wTWFwLmhhcyhwcm9wKSkge1xuICAgICAgICAgIHByb3AgPSBwcm9wTWFwLmdldChwcm9wKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZpZXcgPSB2aWV3W3Byb3BdO1xuICAgICAgICBwcm9wTWFwID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHZpZXcpO1xuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB2aWV3ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5zZXRQcm9wZXJ0eUludGVybmFsKHZpZXcsIGF0dHJpYnV0ZU5hbWUsIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJ1bnNJbihwbGF0Zm9ybTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgbGV0IHJ1bnMgPSB0cnVlO1xuICAgIGNvbnN0IGxhc3QgPSAoKSA9PiB0cnVlO1xuICAgIGlmICh0aGlzLm5hbWVzcGFjZUZpbHRlcnMpIHtcbiAgICAgIGxldCBjaGFpbiA9IChwOiBzdHJpbmcpID0+IHRydWU7XG4gICAgICBmb3IgKGxldCBpID0gdGhpcy5uYW1lc3BhY2VGaWx0ZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDaGFpbiA9IGNoYWluO1xuICAgICAgICBjaGFpbiA9IChwKSA9PiB0aGlzLm5hbWVzcGFjZUZpbHRlcnNbaV0ucnVuc0luKHAsIGN1cnJlbnRDaGFpbik7XG4gICAgICB9XG4gICAgICBydW5zID0gY2hhaW4ocGxhdGZvcm0pO1xuICAgICAgcnVucyA9IHJ1bnMgIT09IGZhbHNlID8gdHJ1ZSA6IGZhbHNlOyAvLyB1bmRlZmluZWQgbWVhbnMgdHJ1ZVxuICAgICAgLy8gdGhpcy5uYW1lc3BhY2VGaWx0ZXJzLnNvbWUoKGZpbHRlcikgPT4ge1xuICAgICAgLy8gXHRjb25zdCBydW5zSW5GaWx0ZXIgPSBmaWx0ZXIucnVuc0luKHBsYXRmb3JtKTtcbiAgICAgIC8vIFx0aWYgKHJ1bnNJbkZpbHRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAvLyBcdFx0cnVucyA9IHJ1bnNJbkZpbHRlcjtcbiAgICAgIC8vIFx0XHRyZXR1cm4gdHJ1ZTtcbiAgICAgIC8vIFx0fVxuICAgICAgLy8gfSk7XG4gICAgfVxuICAgIHJldHVybiBydW5zO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQcm9wZXJ0eUludGVybmFsKHZpZXc6IE5nVmlldywgYXR0cmlidXRlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgU2V0dGluZyBhdHRyaWJ1dGU6ICR7YXR0cmlidXRlTmFtZX09JHt2YWx1ZX0gdG8gJHt2aWV3fWApO1xuICAgIH1cblxuICAgIGlmIChhdHRyaWJ1dGVOYW1lID09PSAnY2xhc3MnKSB7XG4gICAgICB0aGlzLnNldENsYXNzZXModmlldywgdmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChYTUxfQVRUUklCVVRFUy5pbmRleE9mKGF0dHJpYnV0ZU5hbWUpICE9PSAtMSkge1xuICAgICAgdmlld1thdHRyaWJ1dGVOYW1lXSA9IHZhbHVlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHByb3BNYXAgPSB0aGlzLmdldFByb3BlcnRpZXModmlldyk7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcE1hcC5nZXQoYXR0cmlidXRlTmFtZSk7XG5cbiAgICAvLyBFbnN1cmUgdGhlIGNoaWxkcmVuIG9mIGEgY29sbGVjdGlvbiBjdXJyZW50bHkgaGF2ZSBubyBwYXJlbnQgc2V0LlxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgdGhpcy5yZW1vdmVQYXJlbnRSZWZlcmVuY2VzRnJvbUl0ZW1zKHZhbHVlKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcGVydHlOYW1lKSB7XG4gICAgICAvLyBXZSBoYXZlIGEgbG93ZXItdXBwZXIgY2FzZSBtYXBwZWQgcHJvcGVydHkuXG4gICAgICB2aWV3W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBVbmtub3duIGF0dHJpYnV0ZSB2YWx1ZSAtLSBqdXN0IHNldCBpdCB0byBvdXIgb2JqZWN0IGFzIGlzLlxuICAgIHZpZXdbYXR0cmlidXRlTmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlUGFyZW50UmVmZXJlbmNlc0Zyb21JdGVtcyhpdGVtczogYW55W10pOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICAgIGlmIChpdGVtLnBhcmVudCAmJiBpdGVtLnBhcmVudE5vZGUpIHtcbiAgICAgICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFVuYXNzaWduaW5nIHBhcmVudCAke2l0ZW0ucGFyZW50Tm9kZX0gb24gdmFsdWU6ICR7aXRlbX1gKTtcbiAgICAgICAgfVxuICAgICAgICBpdGVtLnBhcmVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgaXRlbS5wYXJlbnROb2RlID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJvcGVydGllcyhpbnN0YW5jZTogYW55KTogTWFwPHN0cmluZywgc3RyaW5nPiB7XG4gICAgY29uc3QgdHlwZSA9IGluc3RhbmNlICYmIGluc3RhbmNlLmNvbnN0cnVjdG9yO1xuICAgIGlmICghdHlwZSkge1xuICAgICAgcmV0dXJuIG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gICAgfVxuXG4gICAgaWYgKCFwcm9wZXJ0eU1hcHMuaGFzKHR5cGUpKSB7XG4gICAgICBjb25zdCBwcm9wTWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICAgIGZvciAoY29uc3QgcHJvcE5hbWUgaW4gaW5zdGFuY2UpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGU6Zm9yaW5cbiAgICAgICAgcHJvcE1hcC5zZXQocHJvcE5hbWUudG9Mb3dlckNhc2UoKSwgcHJvcE5hbWUpO1xuICAgICAgfVxuICAgICAgcHJvcGVydHlNYXBzLnNldCh0eXBlLCBwcm9wTWFwKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvcGVydHlNYXBzLmdldCh0eXBlKTtcbiAgfVxuXG4gIHByaXZhdGUgY3NzQ2xhc3Nlcyh2aWV3OiBOZ1ZpZXcpIHtcbiAgICBpZiAoIXZpZXcubmdDc3NDbGFzc2VzKSB7XG4gICAgICB2aWV3Lm5nQ3NzQ2xhc3NlcyA9IG5ldyBNYXA8c3RyaW5nLCBib29sZWFuPigpO1xuICAgIH1cbiAgICByZXR1cm4gdmlldy5uZ0Nzc0NsYXNzZXM7XG4gIH1cblxuICBwdWJsaWMgYWRkQ2xhc3ModmlldzogVmlldyB8IE5nVmlldywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBleHRlbmRlZFZpZXcgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnModmlldyk7XG4gICAgdGhpcy5jc3NDbGFzc2VzKGV4dGVuZGVkVmlldykuc2V0KGNsYXNzTmFtZSwgdHJ1ZSk7XG4gICAgdGhpcy5zeW5jQ2xhc3NlcyhleHRlbmRlZFZpZXcpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZUNsYXNzKHZpZXc6IFZpZXcsIGNsYXNzTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZXh0ZW5kZWRWaWV3ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHZpZXcpO1xuICAgIHRoaXMuY3NzQ2xhc3NlcyhleHRlbmRlZFZpZXcpLmRlbGV0ZShjbGFzc05hbWUpO1xuICAgIHRoaXMuc3luY0NsYXNzZXMoZXh0ZW5kZWRWaWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q2xhc3Nlcyh2aWV3OiBOZ1ZpZXcsIGNsYXNzZXNWYWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzZXNWYWx1ZS5zcGxpdCh3aGl0ZVNwYWNlU3BsaXR0ZXIpO1xuICAgIHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5jbGVhcigpO1xuICAgIGNsYXNzZXMuZm9yRWFjaCgoY2xhc3NOYW1lKSA9PiB0aGlzLmNzc0NsYXNzZXModmlldykuc2V0KGNsYXNzTmFtZSwgdHJ1ZSkpO1xuICAgIHRoaXMuc3luY0NsYXNzZXModmlldyk7XG4gIH1cblxuICBwcml2YXRlIHN5bmNDbGFzc2VzKHZpZXc6IE5nVmlldyk6IHZvaWQge1xuICAgIGNvbnN0IGNsYXNzVmFsdWUgPSAoPGFueT5BcnJheSkuZnJvbSh0aGlzLmNzc0NsYXNzZXModmlldykua2V5cygpKS5qb2luKCcgJyk7XG4gICAgdmlldy5jbGFzc05hbWUgPSBjbGFzc1ZhbHVlO1xuICB9XG5cbiAgcHVibGljIHNldFN0eWxlKHZpZXc6IFZpZXcsIHN0eWxlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgaWYgKGlzQ3NzVmFyaWFibGUoc3R5bGVOYW1lKSkge1xuICAgICAgdmlldy5zdHlsZS5zZXRVbnNjb3BlZENzc1ZhcmlhYmxlKHN0eWxlTmFtZSwgdmFsdWUpO1xuICAgICAgdmlldy5fb25Dc3NTdGF0ZUNoYW5nZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2aWV3LnN0eWxlW3N0eWxlTmFtZV0gPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlU3R5bGUodmlldzogVmlldywgc3R5bGVOYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAoaXNDc3NWYXJpYWJsZShzdHlsZU5hbWUpKSB7XG4gICAgICAvLyBUT0RPOiBleHBvc2UgdGhpcyBvbiBjb3JlXG4gICAgICAodmlldy5zdHlsZSBhcyBhbnkpLnVuc2NvcGVkQ3NzVmFyaWFibGVzLmRlbGV0ZShzdHlsZU5hbWUpO1xuICAgICAgdmlldy5fb25Dc3NTdGF0ZUNoYW5nZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2aWV3LnN0eWxlW3N0eWxlTmFtZV0gPSB1bnNldFZhbHVlO1xuICAgIH1cbiAgfVxufVxuIl19