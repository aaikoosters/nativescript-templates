import { __decorate, __metadata, __param } from "tslib";
import { ApplicationRef, ComponentFactoryResolver, Injector, Optional } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { fromEvent, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { NSLocationStrategy } from '../../legacy/router/ns-location-strategy';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { DetachedLoader } from '../detached-loader';
import { NativeScriptDomPortalOutlet } from '../portal/nsdom-portal-outlet';
import { NativeDialogConfig } from './dialog-config';
let NativeModalRef = class NativeModalRef {
    constructor(_config, _injector, location) {
        this._config = _config;
        this._injector = _injector;
        this.location = location;
        this.stateChanged = new Subject();
        this.onDismiss = new Subject();
        this._isDismissed = false;
        let parentView = this._config.viewContainerRef?.element.nativeElement || Application.getRootView();
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        while (parentView._modal || parentView._ngDialogRoot) {
            parentView = parentView._modal || parentView._ngDialogRoot;
        }
        this.parentView = parentView;
        this._closeCallback = once(async () => {
            this.stateChanged.next({ state: 'closing' });
            if (!this._isDismissed) {
                this.modalViewRef.firstNativeLikeView?.closeModal();
            }
            await this.location?._closeModalNavigation();
            // this.detachedLoaderRef?.destroy();
            if (this.modalViewRef?.firstNativeLikeView.isLoaded) {
                fromEvent(this.modalViewRef.firstNativeLikeView, 'unloaded')
                    .pipe(take(1))
                    .subscribe(() => this.stateChanged.next({ state: 'closed' }));
            }
            else {
                this.stateChanged.next({ state: 'closed' });
            }
        });
    }
    _generateDetachedContainer(vcRef) {
        const detachedFactory = (this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver)).resolveComponentFactory(DetachedLoader);
        if (vcRef) {
            this.detachedLoaderRef = vcRef.createComponent(detachedFactory);
        }
        else {
            this.detachedLoaderRef = detachedFactory.create(this._config.viewContainerRef?.injector || this._injector);
            this._injector.get(ApplicationRef).attachView(this.detachedLoaderRef.hostView);
        }
        this.detachedLoaderRef.changeDetectorRef.detectChanges();
    }
    attachTemplatePortal(portal) {
        this.startModalNavigation();
        const vcRef = portal.viewContainerRef || this._config.viewContainerRef;
        this._generateDetachedContainer(vcRef);
        portal.viewContainerRef = this.detachedLoaderRef.instance.vc;
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const templateRef = this.portalOutlet.attach(portal);
        this.modalViewRef = new NgViewRef(templateRef);
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                await this.location?._closeModalNavigation();
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        //   if (this.modalView !== templateRef.rootNodes[0]) {
        //     componentRef.location.nativeElement._ngDialogRoot = this.modalView;
        //   }
        return templateRef;
    }
    attachComponentPortal(portal) {
        this.startModalNavigation();
        const targetView = new ContentView();
        this.portalOutlet = new NativeScriptDomPortalOutlet(targetView, this._config.componentFactoryResolver || this._injector.get(ComponentFactoryResolver), this._injector.get(ApplicationRef), this._injector);
        const componentRef = this.portalOutlet.attach(portal);
        componentRef.changeDetectorRef.detectChanges();
        this.modalViewRef = new NgViewRef(componentRef);
        if (this.modalViewRef.firstNativeLikeView !== this.modalViewRef.view) {
            this.modalViewRef.view._ngDialogRoot = this.modalViewRef.firstNativeLikeView;
        }
        this.modalViewRef.firstNativeLikeView['__ng_modal_id__'] = this._id;
        // if we don't detach the view from its parent, ios gets mad
        this.modalViewRef.detachNativeLikeView();
        const userOptions = this._config.nativeOptions || {};
        this.parentView.showModal(this.modalViewRef.firstNativeLikeView, {
            context: null,
            ...userOptions,
            closeCallback: async () => {
                this._isDismissed = true;
                this._closeCallback(); // close callback can only be called once, so we call it here to setup the exit events
                this.onDismiss.next();
                this.onDismiss.complete();
            },
            cancelable: !this._config.disableClose,
        });
        return componentRef;
    }
    _startExitAnimation() {
        this._closeCallback();
    }
    dispose() {
        this.portalOutlet.dispose();
    }
    startModalNavigation() {
        const frame = this.parentView instanceof Frame ? this.parentView : this.parentView?.page?.frame || Frame.topmost();
        this.location?._beginModalNavigation(frame);
    }
};
NativeModalRef = __decorate([
    __param(2, Optional()),
    __metadata("design:paramtypes", [NativeDialogConfig, Injector, NSLocationStrategy])
], NativeModalRef);
export { NativeModalRef };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLW1vZGFsLXJlZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2FuZ3VsYXIvc3JjL2xpYi9jZGsvZGlhbG9nL25hdGl2ZS1tb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsd0JBQXdCLEVBQWlDLFFBQVEsRUFBRSxRQUFRLEVBQW9CLE1BQU0sZUFBZSxDQUFDO0FBQzlJLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzNFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDOUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFcEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUMsSUFBTSxjQUFjLEdBQXBCLE1BQU0sY0FBYztJQWF6QixZQUFvQixPQUEyQixFQUFVLFNBQW1CLEVBQXNCLFFBQTZCO1FBQTNHLFlBQU8sR0FBUCxPQUFPLENBQW9CO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBVTtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQVgvSCxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUE4QyxDQUFDO1FBQ3pFLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBUXhCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBRzNCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGFBQWEsSUFBSSxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkcsSUFBSSxDQUFDLFVBQVUsWUFBWSxXQUFXLElBQUksVUFBVSxZQUFZLGdCQUFnQixDQUFDLElBQUksVUFBVSxDQUFDLFNBQVMsRUFBRTtZQUN6RyxVQUFVLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztTQUNuQztRQUVELHFFQUFxRTtRQUNyRSxxRkFBcUY7UUFDckYsaUNBQWlDO1FBQ2pDLE9BQU8sVUFBVSxDQUFDLE1BQU0sSUFBSSxVQUFVLENBQUMsYUFBYSxFQUFFO1lBQ3BELFVBQVUsR0FBRyxVQUFVLENBQUMsTUFBTSxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUM7U0FDNUQ7UUFDRCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUU3QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNwQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixFQUFFLFVBQVUsRUFBRSxDQUFDO2FBQ3JEO1lBQ0QsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFLHFCQUFxQixFQUFFLENBQUM7WUFDN0MscUNBQXFDO1lBQ3JDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUU7Z0JBQ25ELFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixFQUFFLFVBQVUsQ0FBQztxQkFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDYixTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ2pFO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7YUFDN0M7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCwwQkFBMEIsQ0FBQyxLQUF3QjtRQUNqRCxNQUFNLGVBQWUsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsd0JBQXdCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3hKLElBQUksS0FBSyxFQUFFO1lBQ1QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDakU7YUFBTTtZQUNMLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsUUFBUSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ2hGO1FBQ0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQzNELENBQUM7SUFFRCxvQkFBb0IsQ0FBSSxNQUF5QjtRQUMvQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUM1QixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztRQUN2RSxJQUFJLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBQzdELE1BQU0sVUFBVSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLDJCQUEyQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLHdCQUF3QixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNNLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDcEUsNERBQTREO1FBQzVELElBQUksQ0FBQyxZQUFZLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUV6QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsRUFBRTtZQUMvRCxPQUFPLEVBQUUsSUFBSTtZQUNiLEdBQUcsV0FBVztZQUNkLGFBQWEsRUFBRSxLQUFLLElBQUksRUFBRTtnQkFDeEIsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFLHFCQUFxQixFQUFFLENBQUM7Z0JBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDNUIsQ0FBQztZQUNELFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWTtTQUN2QyxDQUFDLENBQUM7UUFDSCx1REFBdUQ7UUFDdkQsMEVBQTBFO1FBQzFFLE1BQU07UUFDTixPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRUQscUJBQXFCLENBQUksTUFBMEI7UUFDakQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFNUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksMkJBQTJCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsd0JBQXdCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDM00sTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEQsWUFBWSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDaEQsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQzlELElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixDQUFDO1NBQ3JGO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDcEUsNERBQTREO1FBQzVELElBQUksQ0FBQyxZQUFZLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUV6QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsRUFBRTtZQUMvRCxPQUFPLEVBQUUsSUFBSTtZQUNiLEdBQUcsV0FBVztZQUNkLGFBQWEsRUFBRSxLQUFLLElBQUksRUFBRTtnQkFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ3pCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLHNGQUFzRjtnQkFDN0csSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM1QixDQUFDO1lBQ0QsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZO1NBQ3ZDLENBQUMsQ0FBQztRQUNILE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRCxtQkFBbUI7UUFDakIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxPQUFPO1FBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBQ08sb0JBQW9CO1FBQzFCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxLQUFLLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRW5ILElBQUksQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUMsQ0FBQztDQUNGLENBQUE7QUFoSVksY0FBYztJQWFzRCxXQUFBLFFBQVEsRUFBRSxDQUFBO3FDQUE1RCxrQkFBa0IsRUFBcUIsUUFBUSxFQUFpQyxrQkFBa0I7R0FicEgsY0FBYyxDQWdJMUI7U0FoSVksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRW1iZWRkZWRWaWV3UmVmLCBJbmplY3RvciwgT3B0aW9uYWwsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb250ZW50VmlldywgRnJhbWUsIFZpZXcgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwSG9zdEFzeW5jVmlldywgQXBwSG9zdFZpZXcgfSBmcm9tICcuLi8uLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IE5TTG9jYXRpb25TdHJhdGVneSB9IGZyb20gJy4uLy4uL2xlZ2FjeS9yb3V0ZXIvbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuaW1wb3J0IHsgb25jZSB9IGZyb20gJy4uLy4uL3V0aWxzL2dlbmVyYWwnO1xuaW1wb3J0IHsgTmdWaWV3UmVmIH0gZnJvbSAnLi4vLi4vdmlldy1yZWZzJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vZGV0YWNoZWQtbG9hZGVyJztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICcuLi9wb3J0YWwvY29tbW9uJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCB9IGZyb20gJy4uL3BvcnRhbC9uc2RvbS1wb3J0YWwtb3V0bGV0JztcbmltcG9ydCB7IE5hdGl2ZURpYWxvZ0NvbmZpZyB9IGZyb20gJy4vZGlhbG9nLWNvbmZpZyc7XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVNb2RhbFJlZiB7XG4gIF9pZDogc3RyaW5nO1xuICBzdGF0ZUNoYW5nZWQgPSBuZXcgU3ViamVjdDx7IHN0YXRlOiAnb3BlbmVkJyB8ICdjbG9zZWQnIHwgJ2Nsb3NpbmcnIH0+KCk7XG4gIG9uRGlzbWlzcyA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcGFyZW50VmlldzogVmlldztcbiAgcG9ydGFsT3V0bGV0OiBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQ7XG4gIGRldGFjaGVkTG9hZGVyUmVmOiBDb21wb25lbnRSZWY8RGV0YWNoZWRMb2FkZXI+O1xuICBtb2RhbFZpZXdSZWY6IE5nVmlld1JlZjxhbnk+O1xuXG4gIHByaXZhdGUgX2Nsb3NlQ2FsbGJhY2s6ICgpID0+IHZvaWQ7XG4gIHByaXZhdGUgX2lzRGlzbWlzc2VkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfY29uZmlnOiBOYXRpdmVEaWFsb2dDb25maWcsIHByaXZhdGUgX2luamVjdG9yOiBJbmplY3RvciwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsb2NhdGlvbj86IE5TTG9jYXRpb25TdHJhdGVneSkge1xuICAgIGxldCBwYXJlbnRWaWV3ID0gdGhpcy5fY29uZmlnLnZpZXdDb250YWluZXJSZWY/LmVsZW1lbnQubmF0aXZlRWxlbWVudCB8fCBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpO1xuXG4gICAgaWYgKChwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdFZpZXcgfHwgcGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RBc3luY1ZpZXcpICYmIHBhcmVudFZpZXcubmdBcHBSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5uZ0FwcFJvb3Q7XG4gICAgfVxuXG4gICAgLy8gX25nRGlhbG9nUm9vdCBpcyB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIHByZXZpb3VzbHkgZGV0YWNoZWQgcHJveHkuXG4gICAgLy8gSXQgc2hvdWxkIGhhdmUgJ3ZpZXdDb250cm9sbGVyJyAoaU9TKSBvciAnX2RpYWxvZ0ZyYWdtZW50JyAoQW5kcm9pZCkgYXZhaWxhYmxlIGZvclxuICAgIC8vIHByZXNlbnRpbmcgZnV0dXJlIG1vZGFsIHZpZXdzLlxuICAgIHdoaWxlIChwYXJlbnRWaWV3Ll9tb2RhbCB8fCBwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3QpIHtcbiAgICAgIHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Ll9tb2RhbCB8fCBwYXJlbnRWaWV3Ll9uZ0RpYWxvZ1Jvb3Q7XG4gICAgfVxuICAgIHRoaXMucGFyZW50VmlldyA9IHBhcmVudFZpZXc7XG5cbiAgICB0aGlzLl9jbG9zZUNhbGxiYWNrID0gb25jZShhc3luYyAoKSA9PiB7XG4gICAgICB0aGlzLnN0YXRlQ2hhbmdlZC5uZXh0KHsgc3RhdGU6ICdjbG9zaW5nJyB9KTtcbiAgICAgIGlmICghdGhpcy5faXNEaXNtaXNzZWQpIHtcbiAgICAgICAgdGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldz8uY2xvc2VNb2RhbCgpO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5sb2NhdGlvbj8uX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgICAvLyB0aGlzLmRldGFjaGVkTG9hZGVyUmVmPy5kZXN0cm95KCk7XG4gICAgICBpZiAodGhpcy5tb2RhbFZpZXdSZWY/LmZpcnN0TmF0aXZlTGlrZVZpZXcuaXNMb2FkZWQpIHtcbiAgICAgICAgZnJvbUV2ZW50KHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsICd1bmxvYWRlZCcpXG4gICAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMuc3RhdGVDaGFuZ2VkLm5leHQoeyBzdGF0ZTogJ2Nsb3NlZCcgfSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZWQubmV4dCh7IHN0YXRlOiAnY2xvc2VkJyB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIF9nZW5lcmF0ZURldGFjaGVkQ29udGFpbmVyKHZjUmVmPzogVmlld0NvbnRhaW5lclJlZikge1xuICAgIGNvbnN0IGRldGFjaGVkRmFjdG9yeSA9ICh0aGlzLl9jb25maWcuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHx8IHRoaXMuX2luamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpKS5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG4gICAgaWYgKHZjUmVmKSB7XG4gICAgICB0aGlzLmRldGFjaGVkTG9hZGVyUmVmID0gdmNSZWYuY3JlYXRlQ29tcG9uZW50KGRldGFjaGVkRmFjdG9yeSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYgPSBkZXRhY2hlZEZhY3RvcnkuY3JlYXRlKHRoaXMuX2NvbmZpZy52aWV3Q29udGFpbmVyUmVmPy5pbmplY3RvciB8fCB0aGlzLl9pbmplY3Rvcik7XG4gICAgICB0aGlzLl9pbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLmF0dGFjaFZpZXcodGhpcy5kZXRhY2hlZExvYWRlclJlZi5ob3N0Vmlldyk7XG4gICAgfVxuICAgIHRoaXMuZGV0YWNoZWRMb2FkZXJSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgYXR0YWNoVGVtcGxhdGVQb3J0YWw8VD4ocG9ydGFsOiBUZW1wbGF0ZVBvcnRhbDxUPik6IEVtYmVkZGVkVmlld1JlZjxUPiB7XG4gICAgdGhpcy5zdGFydE1vZGFsTmF2aWdhdGlvbigpO1xuICAgIGNvbnN0IHZjUmVmID0gcG9ydGFsLnZpZXdDb250YWluZXJSZWYgfHwgdGhpcy5fY29uZmlnLnZpZXdDb250YWluZXJSZWY7XG4gICAgdGhpcy5fZ2VuZXJhdGVEZXRhY2hlZENvbnRhaW5lcih2Y1JlZik7XG4gICAgcG9ydGFsLnZpZXdDb250YWluZXJSZWYgPSB0aGlzLmRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLnZjO1xuICAgIGNvbnN0IHRhcmdldFZpZXcgPSBuZXcgQ29udGVudFZpZXcoKTtcbiAgICB0aGlzLnBvcnRhbE91dGxldCA9IG5ldyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQodGFyZ2V0VmlldywgdGhpcy5fY29uZmlnLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB8fCB0aGlzLl9pbmplY3Rvci5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSwgdGhpcy5faW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKSwgdGhpcy5faW5qZWN0b3IpO1xuICAgIGNvbnN0IHRlbXBsYXRlUmVmID0gdGhpcy5wb3J0YWxPdXRsZXQuYXR0YWNoKHBvcnRhbCk7XG4gICAgdGhpcy5tb2RhbFZpZXdSZWYgPSBuZXcgTmdWaWV3UmVmKHRlbXBsYXRlUmVmKTtcbiAgICB0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3WydfX25nX21vZGFsX2lkX18nXSA9IHRoaXMuX2lkO1xuICAgIC8vIGlmIHdlIGRvbid0IGRldGFjaCB0aGUgdmlldyBmcm9tIGl0cyBwYXJlbnQsIGlvcyBnZXRzIG1hZFxuICAgIHRoaXMubW9kYWxWaWV3UmVmLmRldGFjaE5hdGl2ZUxpa2VWaWV3KCk7XG5cbiAgICBjb25zdCB1c2VyT3B0aW9ucyA9IHRoaXMuX2NvbmZpZy5uYXRpdmVPcHRpb25zIHx8IHt9O1xuICAgIHRoaXMucGFyZW50Vmlldy5zaG93TW9kYWwodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldywge1xuICAgICAgY29udGV4dDogbnVsbCxcbiAgICAgIC4uLnVzZXJPcHRpb25zLFxuICAgICAgY2xvc2VDYWxsYmFjazogYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmxvY2F0aW9uPy5fY2xvc2VNb2RhbE5hdmlnYXRpb24oKTtcbiAgICAgICAgdGhpcy5vbkRpc21pc3MubmV4dCgpO1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5jb21wbGV0ZSgpO1xuICAgICAgfSxcbiAgICAgIGNhbmNlbGFibGU6ICF0aGlzLl9jb25maWcuZGlzYWJsZUNsb3NlLFxuICAgIH0pO1xuICAgIC8vICAgaWYgKHRoaXMubW9kYWxWaWV3ICE9PSB0ZW1wbGF0ZVJlZi5yb290Tm9kZXNbMF0pIHtcbiAgICAvLyAgICAgY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQuX25nRGlhbG9nUm9vdCA9IHRoaXMubW9kYWxWaWV3O1xuICAgIC8vICAgfVxuICAgIHJldHVybiB0ZW1wbGF0ZVJlZjtcbiAgfVxuXG4gIGF0dGFjaENvbXBvbmVudFBvcnRhbDxUPihwb3J0YWw6IENvbXBvbmVudFBvcnRhbDxUPik6IENvbXBvbmVudFJlZjxUPiB7XG4gICAgdGhpcy5zdGFydE1vZGFsTmF2aWdhdGlvbigpO1xuXG4gICAgY29uc3QgdGFyZ2V0VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICAgIHRoaXMucG9ydGFsT3V0bGV0ID0gbmV3IE5hdGl2ZVNjcmlwdERvbVBvcnRhbE91dGxldCh0YXJnZXRWaWV3LCB0aGlzLl9jb25maWcuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHx8IHRoaXMuX2luamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpLCB0aGlzLl9pbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLCB0aGlzLl9pbmplY3Rvcik7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5wb3J0YWxPdXRsZXQuYXR0YWNoKHBvcnRhbCk7XG4gICAgY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLm1vZGFsVmlld1JlZiA9IG5ldyBOZ1ZpZXdSZWYoY29tcG9uZW50UmVmKTtcbiAgICBpZiAodGhpcy5tb2RhbFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldyAhPT0gdGhpcy5tb2RhbFZpZXdSZWYudmlldykge1xuICAgICAgKDxhbnk+dGhpcy5tb2RhbFZpZXdSZWYudmlldykuX25nRGlhbG9nUm9vdCA9IHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXc7XG4gICAgfVxuICAgIHRoaXMubW9kYWxWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXdbJ19fbmdfbW9kYWxfaWRfXyddID0gdGhpcy5faWQ7XG4gICAgLy8gaWYgd2UgZG9uJ3QgZGV0YWNoIHRoZSB2aWV3IGZyb20gaXRzIHBhcmVudCwgaW9zIGdldHMgbWFkXG4gICAgdGhpcy5tb2RhbFZpZXdSZWYuZGV0YWNoTmF0aXZlTGlrZVZpZXcoKTtcblxuICAgIGNvbnN0IHVzZXJPcHRpb25zID0gdGhpcy5fY29uZmlnLm5hdGl2ZU9wdGlvbnMgfHwge307XG4gICAgdGhpcy5wYXJlbnRWaWV3LnNob3dNb2RhbCh0aGlzLm1vZGFsVmlld1JlZi5maXJzdE5hdGl2ZUxpa2VWaWV3LCB7XG4gICAgICBjb250ZXh0OiBudWxsLFxuICAgICAgLi4udXNlck9wdGlvbnMsXG4gICAgICBjbG9zZUNhbGxiYWNrOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRoaXMuX2lzRGlzbWlzc2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5fY2xvc2VDYWxsYmFjaygpOyAvLyBjbG9zZSBjYWxsYmFjayBjYW4gb25seSBiZSBjYWxsZWQgb25jZSwgc28gd2UgY2FsbCBpdCBoZXJlIHRvIHNldHVwIHRoZSBleGl0IGV2ZW50c1xuICAgICAgICB0aGlzLm9uRGlzbWlzcy5uZXh0KCk7XG4gICAgICAgIHRoaXMub25EaXNtaXNzLmNvbXBsZXRlKCk7XG4gICAgICB9LFxuICAgICAgY2FuY2VsYWJsZTogIXRoaXMuX2NvbmZpZy5kaXNhYmxlQ2xvc2UsXG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbXBvbmVudFJlZjtcbiAgfVxuXG4gIF9zdGFydEV4aXRBbmltYXRpb24oKSB7XG4gICAgdGhpcy5fY2xvc2VDYWxsYmFjaygpO1xuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLnBvcnRhbE91dGxldC5kaXNwb3NlKCk7XG4gIH1cbiAgcHJpdmF0ZSBzdGFydE1vZGFsTmF2aWdhdGlvbigpIHtcbiAgICBjb25zdCBmcmFtZSA9IHRoaXMucGFyZW50VmlldyBpbnN0YW5jZW9mIEZyYW1lID8gdGhpcy5wYXJlbnRWaWV3IDogdGhpcy5wYXJlbnRWaWV3Py5wYWdlPy5mcmFtZSB8fCBGcmFtZS50b3Btb3N0KCk7XG5cbiAgICB0aGlzLmxvY2F0aW9uPy5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWUpO1xuICB9XG59XG4iXX0=